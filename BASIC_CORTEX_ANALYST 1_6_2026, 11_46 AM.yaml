name: BASIC_CORTEX_ANALYST
tables:
  - name: ARD_GIACO_TM_HCP_ACUTE_MKT_WEEKLY_LAAD
    description: The table contains records of healthcare provider performance metrics in acute care settings, tracked on a weekly basis. Each record represents a healthcare provider's acute episode activity within specific territories and includes details about provider characteristics, geographic location, product categories, and territorial assignments.
    base_table:
      database: DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB
      schema: REPORTING
      table: ARD_GIACO_TM_HCP_ACUTE_MKT_WEEKLY_LAAD
    dimensions:
      - name: BRANDED_FLAG
        description: Indicates whether the product is a branded medication.
        expr: BRANDED_FLAG
        data_type: VARCHAR(16777216)
        sample_values:
          - 'N'
          - 'Y'
      - name: GOLDEN_ID
        description: A unique identifier used to link and track healthcare providers across different systems and databases.
        expr: GOLDEN_ID
        data_type: VARCHAR(16777216)
        sample_values:
          - GLD004700470057009305
          - GLD000900090008008206
          - GLD999909691076060401
      - name: HCP_ID
        description: Unique identifier for healthcare providers in the system.
        expr: HCP_ID
        data_type: VARCHAR(32)
        sample_values:
          - 2bb17ea9ca26bb191254a298da5e5b31
          - e78d13c51088736b6ad0abcfb0db5496
          - 232e71209a7c50de00969cff0164f64f
      - name: HCP_SPECIALTY
        description: Healthcare provider medical specialty or professional designation.
        expr: HCP_SPECIALTY
        data_type: VARCHAR(16777216)
        sample_values:
          - GERIATRIC MEDICINE (INTERNAL MEDICINE)
          - COLON & RECTAL SURGERY
          - GENERAL SURGERY
      - name: HCP_SPECIALTY_GROUP
        description: Healthcare provider specialty groups categorizing medical practice areas.
        expr: HCP_SPECIALTY_GROUP
        data_type: VARCHAR(16777216)
        sample_values:
          - SURGERY
          - MEDICINE
          - ALL OTHER
      - name: NPI
        description: National Provider Identifier numbers for healthcare providers.
        expr: NPI
        data_type: VARCHAR(16777216)
        sample_values:
          - '1568438992'
          - '1093197857'
          - '1710410949'
      - name: ONEKEY_HCP_ID
        description: Unique identifier for healthcare professionals in the OneKey system.
        expr: ONEKEY_HCP_ID
        data_type: VARCHAR(16777216)
        sample_values:
          - WUSM00274580
          - WUSR03862562
          - WUSM01303609
      - name: PRACTICE_SETTING
        description: The type of healthcare practice setting where medical services are provided.
        expr: PRACTICE_SETTING
        data_type: VARCHAR(256)
        sample_values:
          - RETAIL
          - DISCHARGE
      - name: PROCEDURE_GROUP
        description: Medical procedure categories or groupings used for classification purposes.
        expr: PROCEDURE_GROUP
        data_type: VARCHAR(256)
        sample_values:
          - LAPAROSCOPIC UROLOGIC PROCEDURES
          - OB/GYN PROCEDURES
          - JOINT REPAIR
      - name: PRODUCT_CATEGORY
        description: Categories of pharmaceutical pain management products used in acute care markets.
        expr: PRODUCT_CATEGORY
        data_type: VARCHAR(256)
        sample_values:
          - ANALGESICS-SEDATIVE COMBINATION
          - DERMATOLOGICAL LOCAL TOPICAL ANESTHETIC
          - MODERATE OPIOID COMBINATIONS
      - name: PRODUCT_FAMILY_GROUP
        description: Pharmaceutical product family groups used for pain management and treatment.
        expr: PRODUCT_FAMILY_GROUP
        data_type: VARCHAR(256)
        sample_values:
          - IBUPROFEN
          - DICLOFENAC
          - MELOXICAM
      - name: PTAM_TERRITORY_ID
        description: Unique identifier for a PTAM (Pain Territory Account Manager) territory.
        expr: PTAM_TERRITORY_ID
        data_type: VARCHAR(255)
        sample_values:
          - V1NAUSA-5733506
          - V1NAUSA-5733204
          - V1NAUSA-5733403
      - name: ROA
        description: Route of administration for the medication or treatment.
        expr: ROA
        data_type: VARCHAR(256)
        sample_values:
          - ORAL
          - Sales territory identifier used to designate specific geographicTOPICAL
          - TOPICAL-PATCH
      - name: SAL_TERRITORY_ID
        description:  or organizational sales regions.
        expr: SAL_TERRITORY_ID
        data_type: VARCHAR(255)
        sample_values:
          - V1NAUSA-5720008
          - V1NAUSA-5720014
          - V1NAUSA-5720013
      - name: SITE_OF_CARE_ZIP_CODE
        description: ZIP codes for healthcare facility locations.
        expr: SITE_OF_CARE_ZIP_CODE
        data_type: VARCHAR(16777216)
        sample_values:
          - '80911'
          - '76903'
          - '32771'
      - name: VERTEX_ID
        description: Unique identifier for a vertex in the healthcare provider network.
        expr: VERTEX_ID
        data_type: VARCHAR(16777216)
        sample_values:
          - '14811523'
          - '14821592'
          - '17503007'
      - name: ZIP_CODE
        description: Postal ZIP codes for geographic locations.
        expr: ZIP_CODE
        data_type: VARCHAR(16777216)
        sample_values:
          - '14621'
          - '01805'
          - '95337'
    time_dimensions:
      - name: DATE_KEY
        description: A date used as a key identifier in the healthcare provider acute market weekly reporting data.
        expr: DATE_KEY
        data_type: DATE
        sample_values:
          - '2025-02-14'
          - '2024-11-15'
          - '2022-11-11'
    facts:
      - name: ACUTE_CALENDAR_DAYS_LAAD
        description: The number of calendar days in the acute care period for look-alike-alike drug analysis.
        expr: ACUTE_CALENDAR_DAYS_LAAD
        data_type: NUMBER(38,5)
        access_modifier: public_access
        sample_values:
          - '1.00000'
          - '3.00000'
          - '10.00000'
      - name: ACUTE_EPISODES_LAAD
        description: The number of acute episodes within the look-ahead period.
        expr: ACUTE_EPISODES_LAAD
        data_type: NUMBER(18,0)
        access_modifier: public_access
        sample_values:
          - '1'
          - '4'
          - '2'
      - name: ACUTE_PROCEDURES_LAAD
        description: The number of acute procedures performed using laparoscopic-assisted abdominal delivery techniques.
        expr: ACUTE_PROCEDURES_LAAD
        data_type: NUMBER(18,0)
        access_modifier: public_access
        sample_values:
          - '1'
          - '3'
          - '2'
      - name: ACUTE_REFILLS_LAAD
        description: The number of acute medication refills within the look-ahead period.
        expr: ACUTE_REFILLS_LAAD
        data_type: NUMBER(13,0)
        access_modifier: public_access
        sample_values:
          - '2'
          - '4'
          - '1'
      - name: ACUTE_TRX_LAAD
        description: The number of acute transactions for the last-as-advertised date period.
        expr: ACUTE_TRX_LAAD
        data_type: NUMBER(18,0)
        access_modifier: public_access
        sample_values:
          - '5'
          - '1'
          - '3'
      - name: ACUTE_TX_DAYS_LAAD
        description: The number of days for acute treatment based on LAAD (Last Available Actual Data).
        expr: ACUTE_TX_DAYS_LAAD
        data_type: NUMBER(38,5)
        access_modifier: public_access
        sample_values:
          - '5.00000'
          - '10.00000'
          - '30.00000'
      - name: ACUTE_UNITS_LAAD
        description: Acute care units measured as a look-ahead average demand.
        expr: ACUTE_UNITS_LAAD
        data_type: NUMBER(38,5)
        access_modifier: public_access
        sample_values:
          - '9.00000'
          - '20.00000'
          - '90.00000'
      - name: WEEK_DT
        description: The date representing the week in the healthcare provider acute market reporting period.
        expr: WEEK_DT
        data_type: NUMBER(10,0)
        access_modifier: public_access
        sample_values:
          - '20240524'
          - '20250418'
          - '20250606'
  - name: TD_GEO_CITY
    description: The table contains records of cities and their geographic information. Each record represents a single city and includes hierarchical location details such as state and country associations, along with precise coordinate data.
    base_table:
      database: DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB
      schema: REPORTING
      table: TD_GEO_CITY
    dimensions:
      - name: GEO_CITY_KEY
        description: A unique identifier key for geographic city records.
        expr: GEO_CITY_KEY
        data_type: VARCHAR(32)
        sample_values:
          - cb004e0c1c429625db774a086579bd3b
          - 3de4110deff030eca4c2da9e8e85ae39
          - 6b5b3307241b5195dd6bfef7630d834e
      - name: GEO_CITY_NAME
        description: The name of a geographic city location.
        expr: GEO_CITY_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - BELLEVUE
          - MATTAPAN
          - TALLAHASSEE FALLS
      - name: GEO_COUNTRY_CD
        description: Geographic country code representing the country where the city is located.
        expr: GEO_COUNTRY_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - US
      - name: GEO_COUNTRY_NAME
        description: The name of the country in a geographic location.
        expr: GEO_COUNTRY_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - UNITED STATES
      - name: GEO_STATE_CD
        description: State codes for geographic locations.
        expr: GEO_STATE_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - XX
          - VT
          - FL
      - name: GEO_STATE_NAME
        description: The name of the state within the United States.
        expr: GEO_STATE_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - SOUTH CAROLINA
          - TENNESSEE
          - NEBRASKA
    facts:
      - name: GEO_COUNTRY_KEY
        description: A unique identifier for countries in the geographic data structure.
        expr: GEO_COUNTRY_KEY
        data_type: NUMBER(38,0)
        access_modifier: public_access
        sample_values:
          - '1'
      - name: GEO_LATITUDE
        description: Geographic latitude coordinate in decimal degrees.
        expr: GEO_LATITUDE
        data_type: NUMBER(11,8)
        access_modifier: public_access
      - name: GEO_LONGITUDE
        description: Geographic longitude coordinate expressed in decimal degrees.
        expr: GEO_LONGITUDE
        data_type: NUMBER(11,8)
        access_modifier: public_access
      - name: GEO_STATE_KEY
        description: Numeric identifier for geographic states.
        expr: GEO_STATE_KEY
        data_type: NUMBER(38,0)
        access_modifier: public_access
        sample_values:
          - '21'
          - '22'
          - '53'
  - name: TD_GEO_LOC
    description: The table contains records of geographic locations with their complete address and coordinate information. Each record represents a specific location and includes hierarchical geographic details from address lines through city, state, postal code, and country levels, as well as precise latitude and longitude coordinates.
    base_table:
      database: DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB
      schema: REPORTING
      table: TD_GEO_LOC
    dimensions:
      - name: GEO_CITY_KEY
        description: A unique identifier key for geographic cities.
        expr: GEO_CITY_KEY
        data_type: VARCHAR(32)
        sample_values:
          - e190c59f3d88823cb626962e558314df
          - 21bb6ea0074b193b6643355e6b83aec2
          - a6a0645ce9ac1995532b4bb9f28ce04c
      - name: GEO_CITY_NAME
        description: Geographic city names.
        expr: GEO_CITY_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - HARRISBURG
          - SAINT LOUIS
          - DEER LODGE
      - name: GEO_COUNTRY_CD
        description: Geographic country code representing the country location.
        expr: GEO_COUNTRY_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - US
      - name: GEO_COUNTRY_NAME
        description: The name of the country in a geographic location.
        expr: GEO_COUNTRY_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - UNITED STATES
      - name: GEO_LOC_KEY
        description: A unique identifier for geographic location records.
        expr: GEO_LOC_KEY
        data_type: VARCHAR(32)
        sample_values:
          - 96a44f5985fb18551e9c45db3d75f237
          - 40665982fb20e15ee0b1e0bde8b43330
          - 512d454f090f878a6e8175cad706cecc
      - name: GEO_POSTAL_CD
        description: Postal codes for geographic locations.
        expr: GEO_POSTAL_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - '45459'
          - '92037'
          - '33175'
      - name: GEO_POSTAL_CD_EXT
        description: A column holding data of type VARCHAR(16777216).
        expr: GEO_POSTAL_CD_EXT
        data_type: VARCHAR(16777216)
      - name: GEO_POSTAL_KEY
        description: A unique identifier key for postal geographic locations.
        expr: GEO_POSTAL_KEY
        data_type: VARCHAR(32)
        sample_values:
          - c3195f6d307dd319bf1275b8f98dca51
          - 1a1c1e45309875960a48106f0b73a0b9
          - f8ca2b7549985685fb5a1275bfcced43
      - name: GEO_STATE_CD
        description: State codes for geographic locations.
        expr: GEO_STATE_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - FL
          - MI
          - MA
      - name: GEO_STATE_NAME
        description: The name of the state within the United States.
        expr: GEO_STATE_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - SOUTH CAROLINA
          - MONTANA
          - PENNSYLVANIA
      - name: LOC_ADDR_LINE_1
        description: Street addresses including house numbers and street names.
        expr: LOC_ADDR_LINE_1
        data_type: VARCHAR(16777216)
        sample_values:
          - 12110 NE 64TH PL
          - 1920 LENLAND AVE
          - 210 BAXTER ST
      - name: LOC_ADDR_LINE_2
        description: Secondary address information such as suite numbers, apartment numbers, or room designations.
        expr: LOC_ADDR_LINE_2
        data_type: VARCHAR(16777216)
        sample_values:
          - UNIT B
          - APT 206
      - name: LOC_ADDR_LINE_3
        description: The third line of a location's address.
        expr: LOC_ADDR_LINE_3
        data_type: VARCHAR(16777216)
      - name: LOC_ADDR_LINE_4
        description: The fourth line of a location's address.
        expr: LOC_ADDR_LINE_4
        data_type: VARCHAR(16777216)
    facts:
      - name: GEO_COUNTRY_KEY
        description: A unique identifier for countries in the geographic location dimension.
        expr: GEO_COUNTRY_KEY
        data_type: NUMBER(38,0)
        access_modifier: public_access
        sample_values:
          - '1'
      - name: GEO_LATITUDE
        description: Geographic latitude coordinate expressed in decimal degrees.
        expr: GEO_LATITUDE
        data_type: NUMBER(11,8)
        access_modifier: public_access
      - name: GEO_LONGITUDE
        description: Geographic longitude coordinate expressed in decimal degrees.
        expr: GEO_LONGITUDE
        data_type: NUMBER(11,8)
        access_modifier: public_access
      - name: GEO_STATE_KEY
        description: Unique identifier for geographic states.
        expr: GEO_STATE_KEY
        data_type: NUMBER(38,0)
        access_modifier: public_access
        sample_values:
          - '59'
          - '22'
          - '30'
  - name: TD_GEO_POSTAL
    description: The table contains records of geographic postal code areas with their associated location hierarchies. Each record represents a postal code and includes details about the corresponding state and country jurisdictions as well as precise geographic coordinates.
    base_table:
      database: DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB
      schema: REPORTING
      table: TD_GEO_POSTAL
    dimensions:
      - name: GEO_COUNTRY_CD
        description: Geographic country code representing the country associated with a postal location.
        expr: GEO_COUNTRY_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - US
      - name: GEO_COUNTRY_KEY
        description: A unique identifier for geographic countries.
        expr: GEO_COUNTRY_KEY
        data_type: NUMBER(38,0)
        sample_values:
          - '1'
      - name: GEO_COUNTRY_NAME
        description: The name of the country in a geographic location.
        expr: GEO_COUNTRY_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - UNITED STATES
      - name: GEO_POSTAL_CD
        description: Postal codes for geographic locations.
        expr: GEO_POSTAL_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - '25205'
          - '62545'
          - '78675'
      - name: GEO_POSTAL_KEY
        description: A unique identifier key for geographic postal code records.
        expr: GEO_POSTAL_KEY
        data_type: VARCHAR(32)
        sample_values:
          - 794d1a9eee30d774236a5186a2b55bf9
          - 0eec7bab53a4751845b83ff0ce77c5a1
          - 728b5b967aeb1d257948dc6e622bbc95
      - name: GEO_STATE_CD
        description: State codes for geographic locations.
        expr: GEO_STATE_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - TX
          - WV
          - MS
      - name: GEO_STATE_KEY
        description: Unique identifier for geographic states within the system.
        expr: GEO_STATE_KEY
        data_type: NUMBER(38,0)
        sample_values:
          - '75'
          - '59'
          - '28'
      - name: GEO_STATE_NAME
        description: The name of the geographic state or territory.
        expr: GEO_STATE_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - GEORGIA
          - NEW JERSEY
          - TEXAS
    facts:
      - name: GEO_LATITUDE
        description: Geographic latitude coordinate expressed in decimal degrees.
        expr: GEO_LATITUDE
        data_type: NUMBER(11,8)
        access_modifier: public_access
      - name: GEO_LONGITUDE
        description: Geographic longitude coordinate expressed in decimal degrees.
        expr: GEO_LONGITUDE
        data_type: NUMBER(11,8)
        access_modifier: public_access
  - name: TD_GEO_STATE
    description: The table contains records of geographic states and their associated countries. Each record includes location identifiers, geographic coordinates, and hierarchical relationships between states and countries.
    base_table:
      database: DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB
      schema: REPORTING
      table: TD_GEO_STATE
    dimensions:
      - name: GEO_COUNTRY_CD
        description: Geographic country code.
        expr: GEO_COUNTRY_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - US
      - name: GEO_COUNTRY_NAME
        description: The name of the country in a geographic location.
        expr: GEO_COUNTRY_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - UNITED STATES
      - name: GEO_STATE_CD
        description: Geographic state codes used to identify states or territories.
        expr: GEO_STATE_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - NC
          - XX
          - DE
      - name: GEO_STATE_NAME
        description: Names of US states and territories.
        expr: GEO_STATE_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - SOUTH CAROLINA
          - DELAWARE
          - NEBRASKA
    facts:
      - name: GEO_COUNTRY_KEY
        description: Geographic country key used as a unique identifier for countries.
        expr: GEO_COUNTRY_KEY
        data_type: NUMBER(38,0)
        access_modifier: public_access
        sample_values:
          - '1'
      - name: GEO_LATITUDE
        description: Geographic latitude coordinates for state locations.
        expr: GEO_LATITUDE
        data_type: NUMBER(11,8)
        access_modifier: public_access
        sample_values:
          - '39.00040000'
          - '34.00040000'
      - name: GEO_LONGITUDE
        description: Geographic longitude coordinates for state locations.
        expr: GEO_LONGITUDE
        data_type: NUMBER(11,8)
        access_modifier: public_access
        sample_values:
          - '-86.25030000'
          - '-71.49980000'
          - '-123.04600000'
      - name: GEO_STATE_KEY
        description: Unique identifier for geographic state records.
        expr: GEO_STATE_KEY
        data_type: NUMBER(38,0)
        access_modifier: public_access
        sample_values:
          - '21'
          - '261'
          - '22'
  - name: TD_HCO
    description: The table contains records of healthcare organizations with their identifying information and regulatory details. Each record includes organizational names, business identifiers, operational status, and licensing information including DEA registrations and HIN numbers across multiple categories.
    base_table:
      database: DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB
      schema: REPORTING
      table: TD_HCO
    dimensions:
      - name: HCO_BUSINESS_NAME
        description: Healthcare organization business name.
        expr: HCO_BUSINESS_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - CSC COMMUNITY PHARMACY
          - ENDOSCOPY AND SURGICAL CARE SUITE
      - name: HCO_CD
        description: Healthcare organization codes used to identify specific healthcare entities.
        expr: HCO_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - '1438'
          - '22740441'
          - '30819949'
      - name: HCO_KEY
        description: A unique identifier key for healthcare organizations.
        expr: HCO_KEY
        data_type: VARCHAR(32)
        sample_values:
          - f40f52d91c6e993b6c7c5af4716c359b
          - 27e97cbb80be61e0fb616254104d33b3
          - a9322f73290eae0c74ca2d7b98379369
      - name: HCO_LEGAL_NAME
        description: The legal name of the healthcare organization.
        expr: HCO_LEGAL_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - BINUR, NIR, OFFICE
          - ALTAMED PHARMACY BOYLE HEIGHTS
          - ONE HEALTH GASTROENTEROLOGY AND HEPATOLOGY
      - name: HCO_NAME
        description: Names of healthcare organizations.
        expr: HCO_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - MYCARE PHARMACY
          - FERRER, OLGA M, OFFICE
          - COSHOCTON REGIONAL MEDICAL CENTER INTENSIVE CARE UNIT
      - name: HCO_P_DEA_LIC_STATUS_CD
        description: Healthcare organization Drug Enforcement Administration license status code.
        expr: HCO_P_DEA_LIC_STATUS_CD
        data_type: VARCHAR(16777216)
      - name: HCO_P_DEA_NUM
        description: Drug Enforcement Administration number for healthcare organizations.
        expr: HCO_P_DEA_NUM
        data_type: VARCHAR(16777216)
        sample_values:
          - FV5496244
          - FG5718347
      - name: HCO_P_GLN_NUM
        description: Healthcare organization primary Global Location Number (GLN).
        expr: HCO_P_GLN_NUM
        data_type: VARCHAR(16777216)
      - name: HCO_P_HIN_NUM
        description: A column holding data of type VARCHAR(16777216).
        expr: HCO_P_HIN_NUM
        data_type: VARCHAR(16777216)
        sample_values:
          - L89YW0W00
          - 38G06QNF1
          - 8N302YY00
      - name: HCO_P_NCPDP_NUM
        description: A column holding data of type VARCHAR(16777216).
        expr: HCO_P_NCPDP_NUM
        data_type: VARCHAR(16777216)
      - name: HCO_P_NPI_NUM
        description: Healthcare organization primary National Provider Identifier number.
        expr: HCO_P_NPI_NUM
        data_type: VARCHAR(16777216)
      - name: HCO_S_DEA_LIC_STATUS_CD
        description: Healthcare organization Drug Enforcement Administration license status code.
        expr: HCO_S_DEA_LIC_STATUS_CD
        data_type: VARCHAR(16777216)
      - name: HCO_S_DEA_NUM
        description: Drug Enforcement Administration number for healthcare organizations.
        expr: HCO_S_DEA_NUM
        data_type: VARCHAR(16777216)
        sample_values:
          - FM3749629
          - FP5150862
      - name: HCO_S_GLN_NUM
        description: Healthcare organization Global Location Number (GLN) used for unique identification in supply chain and healthcare transactions.
        expr: HCO_S_GLN_NUM
        data_type: VARCHAR(16777216)
      - name: HCO_S_HIN_NUM
        description: A column holding data of type VARCHAR(16777216).
        expr: HCO_S_HIN_NUM
        data_type: VARCHAR(16777216)
      - name: HCO_S_NCPDP_NUM
        description: A column holding data of type VARCHAR(16777216).
        expr: HCO_S_NCPDP_NUM
        data_type: VARCHAR(16777216)
      - name: HCO_S_NPI_NUM
        description: National Provider Identifier number for healthcare organizations.
        expr: HCO_S_NPI_NUM
        data_type: VARCHAR(16777216)
      - name: HCO_SDESC
        description: Names of healthcare organizations.
        expr: HCO_SDESC
        data_type: VARCHAR(16777216)
        sample_values:
          - CASPER COLLEGE STUDENT HEALTH SERVICES
          - ROYAL SUPPLIES
          - AVERA SURGICAL ASSOCIATES ENDOSCOPY
      - name: HCO_SRC_ID_IMS
        description: Healthcare organization source identifier from IMS data system.
        expr: HCO_SRC_ID_IMS
        data_type: VARCHAR(16777216)
        sample_values:
          - WUSH00158767
          - '2705090'
          - '22740441'
      - name: HCO_SRC_ID_P_SCRUB
        description: A column holding data of type VARCHAR(16777216).
        expr: HCO_SRC_ID_P_SCRUB
        data_type: VARCHAR(16777216)
      - name: HCO_SRC_ID_P_SFA
        description: A column holding data of type VARCHAR(16777216).
        expr: HCO_SRC_ID_P_SFA
        data_type: VARCHAR(16777216)
      - name: HCO_SRC_ID_S_SCRUB
        description: Healthcare organization source identifier after data scrubbing processes.
        expr: HCO_SRC_ID_S_SCRUB
        data_type: VARCHAR(16777216)
        sample_values:
          - WUSF00046723
          - WUSE01155990
          - WUSF00100048
      - name: HCO_SRC_ID_S_SFA
        description: A column holding data of type VARCHAR(16777216).
        expr: HCO_SRC_ID_S_SFA
        data_type: VARCHAR(16777216)
      - name: HCO_SRC_ID_T_SCRUB
        description: A column holding data of type VARCHAR(16777216).
        expr: HCO_SRC_ID_T_SCRUB
        data_type: VARCHAR(16777216)
      - name: HCO_SRC_ID_T_SFA
        description: A column holding data of type VARCHAR(16777216).
        expr: HCO_SRC_ID_T_SFA
        data_type: VARCHAR(16777216)
      - name: HCO_SRC_ID_WKH
        description: A column holding data of type VARCHAR(16777216).
        expr: HCO_SRC_ID_WKH
        data_type: VARCHAR(16777216)
      - name: HCO_T_DEA_LIC_STATUS_CD
        description: Healthcare organization Drug Enforcement Administration license status code.
        expr: HCO_T_DEA_LIC_STATUS_CD
        data_type: VARCHAR(16777216)
      - name: HCO_T_DEA_NUM
        description: A column holding data of type VARCHAR(16777216).
        expr: HCO_T_DEA_NUM
        data_type: VARCHAR(16777216)
        sample_values:
          - HV00789
          - RM0314790
      - name: HCO_T_GLN_NUM
        description: Healthcare organization trading partner Global Location Number (GLN).
        expr: HCO_T_GLN_NUM
        data_type: VARCHAR(16777216)
      - name: HCO_T_HIN_NUM
        description: A column holding data of type VARCHAR(16777216).
        expr: HCO_T_HIN_NUM
        data_type: VARCHAR(16777216)
      - name: HCO_T_NCPDP_NUM
        description: A column holding data of type VARCHAR(16777216).
        expr: HCO_T_NCPDP_NUM
        data_type: VARCHAR(16777216)
      - name: HCO_T_NPI_NUM
        description: Healthcare organization National Provider Identifier number.
        expr: HCO_T_NPI_NUM
        data_type: VARCHAR(16777216)
    time_dimensions:
      - name: HCO_P_DEA_EXP_DT
        description: The expiration date of the healthcare organization's Drug Enforcement Administration registration.
        expr: HCO_P_DEA_EXP_DT
        data_type: DATE
      - name: HCO_S_DEA_EXP_DT
        description: The expiration date of the healthcare organization's Drug Enforcement Administration registration.
        expr: HCO_S_DEA_EXP_DT
        data_type: DATE
      - name: HCO_T_DEA_EXP_DT
        description: The expiration date of the healthcare organization's Drug Enforcement Administration registration.
        expr: HCO_T_DEA_EXP_DT
        data_type: DATE
    facts:
      - name: HCO_STATUS_KEY
        description: Healthcare organization status identifier key.
        expr: HCO_STATUS_KEY
        data_type: NUMBER(38,0)
        access_modifier: public_access
        sample_values:
          - '1'
      - name: HCO_SUBTYPE_KEY
        description: The unique identifier for the healthcare organization subtype.
        expr: HCO_SUBTYPE_KEY
        data_type: NUMBER(38,0)
        access_modifier: public_access
        sample_values:
          - '35'
          - '30'
          - '39'
  - name: TD_HCO_SUBTYPE
    description: The table contains records of healthcare organization subtypes and their corresponding parent types. Each record represents a specific subtype classification with descriptive information and links to broader organizational type categories.
    base_table:
      database: DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB
      schema: REPORTING
      table: TD_HCO_SUBTYPE
    dimensions:
      - name: HCO_SUBTYPE_CD
        description: Healthcare organization subtype codes that classify different types of medical entities and payer organizations.
        expr: HCO_SUBTYPE_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - VA CMOP
          - PAYER_REG
          - PBM
      - name: HCO_SUBTYPE_DESC
        description: Healthcare organization subtype descriptions that categorize different types of medical entities and payers.
        expr: HCO_SUBTYPE_DESC
        data_type: VARCHAR(16777216)
        sample_values:
          - MCO PBM
          - IDN
          - MCO NATIONAL PAYER
      - name: HCO_SUBTYPE_KEY
        description: Unique identifier for healthcare organization subtypes.
        expr: HCO_SUBTYPE_KEY
        data_type: NUMBER(38,0)
        sample_values:
          - '1'
          - '2'
          - '3'
      - name: HCO_TYPE_CD
        description: Healthcare organization type code indicating the classification of the healthcare organization.
        expr: HCO_TYPE_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - ORG
          - MCO
      - name: HCO_TYPE_DESC
        description: Healthcare organization type description indicating the category or classification of the healthcare entity.
        expr: HCO_TYPE_DESC
        data_type: VARCHAR(16777216)
        sample_values:
          - ORGANIZATION
          - MANAGED CARE ORGANIZATION
      - name: HCO_TYPE_KEY
        description: A unique identifier for healthcare organization types.
        expr: HCO_TYPE_KEY
        data_type: NUMBER(38,0)
        sample_values:
          - '1'
          - '2'
    primary_key:
      columns:
        - HCO_SUBTYPE_KEY
  - name: TD_HCP
    description: The table contains records of healthcare professionals and their personal and professional information. Each record represents an individual healthcare provider and includes demographic details, contact information, educational background, and various status indicators related to communication preferences and professional classifications.
    base_table:
      database: DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB
      schema: REPORTING
      table: TD_HCP
    dimensions:
      - name: AMA_NO_CONTACT
        description: American Medical Association no contact indicator.
        expr: AMA_NO_CONTACT
        data_type: VARCHAR(1)
        sample_values:
          - 'N'
          - 'Y'
      - name: EMAIL_ADDR_P
        description: Email addresses for healthcare professionals.
        expr: EMAIL_ADDR_P
        data_type: VARCHAR(16777216)
        sample_values:
          - ATELIS1150730@WM.PROVIDENCEDIRECT.ORG
          - KATYDM7@HOTMAIL.COM
          - GRANTJSULLIVAN@ATT.NET
      - name: EMAIL_ADDR_S
        description: Email addresses of healthcare providers.
        expr: EMAIL_ADDR_S
        data_type: VARCHAR(16777216)
        sample_values:
          - T.THOMAS@ARCHILDRENS.ORG
          - EHUANG@POST.HARVARD.EDU
          - CGOODWIN@UMC.EDU
      - name: EMAIL_ADDR_T
        description: Email addresses for healthcare providers.
        expr: EMAIL_ADDR_T
        data_type: VARCHAR(16777216)
      - name: HCP_DEGREE
        description: The degree or credential held by the healthcare professional.
        expr: HCP_DEGREE
        data_type: VARCHAR(16777216)
        sample_values:
          - PHT
          - RPH
          - NP
      - name: HCP_FIRST_NAME
        description: The first name of the healthcare provider.
        expr: HCP_FIRST_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - SHANE
          - ROYAL
          - CASIANNE
      - name: HCP_GENDER
        description: The gender of the healthcare provider.
        expr: HCP_GENDER
        data_type: VARCHAR(255)
        sample_values:
          - FEMALE
          - UNKNOWN
      - name: HCP_GRAD_YR
        description: The year when the healthcare provider graduated from their medical program.
        expr: HCP_GRAD_YR
        data_type: VARCHAR(16777216)
        sample_values:
          - '1967'
          - '2019'
          - '1965'
      - name: HCP_KEY
        description: A unique identifier for healthcare providers in the system.
        expr: HCP_KEY
        data_type: VARCHAR(32)
        sample_values:
          - 10f535a03919512d15df722bdf50f8fe
          - 59c026c2a4da8798332fd8140066c866
          - cce70a032d441fc7cf17357da57ffa3e
      - name: HCP_LAST_NAME
        description: Healthcare provider last names.
        expr: HCP_LAST_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - FULP
          - GERBER
          - DIGGINS
      - name: HCP_ME_NUM
        description: Healthcare provider medical education number used for identification purposes.
        expr: HCP_ME_NUM
        data_type: VARCHAR(16777216)
        sample_values:
          - '4950901017'
          - '0230178074'
      - name: HCP_MID_NAME
        description: Middle names of healthcare providers.
        expr: HCP_MID_NAME
        data_type: VARCHAR(16777216)
        sample_values:
          - ANN
          - DARLENE
          - TUCKER
      - name: HCP_P_DEA_BUSINESS_ACTIVITY_CD
        description: Healthcare provider Drug Enforcement Administration business activity code.
        expr: HCP_P_DEA_BUSINESS_ACTIVITY_CD
        data_type: VARCHAR(16777216)
      - name: HCP_P_DEA_DRUG_SCHEDULE
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_P_DEA_DRUG_SCHEDULE
        data_type: VARCHAR(16777216)
      - name: HCP_P_DEA_LIC_STATUS_CD
        description: The status code indicating whether a healthcare provider's Drug Enforcement Administration license is active or inactive.
        expr: HCP_P_DEA_LIC_STATUS_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - ACTIVE
      - name: HCP_P_DEA_NUM
        description: Drug Enforcement Administration number assigned to healthcare providers for prescribing controlled substances.
        expr: HCP_P_DEA_NUM
        data_type: VARCHAR(16777216)
        sample_values:
          - AB7255272
          - BB3188833
      - name: HCP_P_DEA_STATE_OF_LICENSURE
        description: The state where the healthcare provider's Drug Enforcement Administration license is issued.
        expr: HCP_P_DEA_STATE_OF_LICENSURE
        data_type: VARCHAR(16777216)
        sample_values:
          - TX
          - MA
          - LA
      - name: HCP_P_HIN
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_P_HIN
        data_type: VARCHAR(16777216)
      - name: HCP_P_MA_ID
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_P_MA_ID
        data_type: VARCHAR(16777216)
        sample_values:
          - '216513'
          - '166691'
          - '169135'
      - name: HCP_P_NPI_NUM
        description: National Provider Identifier (NPI) numbers for healthcare providers.
        expr: HCP_P_NPI_NUM
        data_type: VARCHAR(16777216)
        sample_values:
          - '1134821382'
          - '1235525957'
          - '1558956375'
      - name: HCP_P_STATE_LIC_NUM
        description: Healthcare provider state license numbers.
        expr: HCP_P_STATE_LIC_NUM
        data_type: VARCHAR(16777216)
        sample_values:
          - PA2022-0048
          - '107955'
          - '238052'
      - name: HCP_P_STATE_LIC_STATE_CD
        description: State code where the healthcare provider holds their professional license.
        expr: HCP_P_STATE_LIC_STATE_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - AR
          - NV
          - TX
      - name: HCP_P_STATE_LIC_STATUS
        description: The status of a healthcare provider's professional state license.
        expr: HCP_P_STATE_LIC_STATUS
        data_type: VARCHAR(16777216)
        sample_values:
          - INACTIVE
          - ACTIVE
      - name: HCP_PDRP_OPTOUT_IND
        description: Healthcare provider Patient Data Request Program opt-out indicator.
        expr: HCP_PDRP_OPTOUT_IND
        data_type: VARCHAR(16777216)
        sample_values:
          - 'Y'
          - 'N'
      - name: HCP_PHONE_HOME_P
        description: Healthcare provider's home phone number.
        expr: HCP_PHONE_HOME_P
        data_type: VARCHAR(16777216)
      - name: HCP_PHONE_MOBILE_P
        description: Mobile phone number for the healthcare provider.
        expr: HCP_PHONE_MOBILE_P
        data_type: VARCHAR(16777216)
      - name: HCP_PHONE_WORK_P
        description: Work phone numbers for healthcare providers.
        expr: HCP_PHONE_WORK_P
        data_type: VARCHAR(16777216)
        sample_values:
          - '3604862900'
          - '2183486888'
          - '9155323937'
      - name: HCP_S_DEA_BUSINESS_ACTIVITY_CD
        description: Drug Enforcement Administration business activity code for healthcare providers.
        expr: HCP_S_DEA_BUSINESS_ACTIVITY_CD
        data_type: VARCHAR(16777216)
      - name: HCP_S_DEA_DRUG_SCHEDULE
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_S_DEA_DRUG_SCHEDULE
        data_type: VARCHAR(16777216)
      - name: HCP_S_DEA_LIC_STATUS_CD
        description: Healthcare provider Drug Enforcement Administration license status code.
        expr: HCP_S_DEA_LIC_STATUS_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - ACTIVE
      - name: HCP_S_DEA_NUM
        description: Drug Enforcement Administration number assigned to healthcare providers for prescribing controlled substances.
        expr: HCP_S_DEA_NUM
        data_type: VARCHAR(16777216)
        sample_values:
          - FG6124919
          - FF8289161
      - name: HCP_S_DEA_STATE_OF_LICENSURE
        description: The state where the healthcare provider's Drug Enforcement Administration license was issued.
        expr: HCP_S_DEA_STATE_OF_LICENSURE
        data_type: VARCHAR(16777216)
        sample_values:
          - VA
          - NE
      - name: HCP_S_HIN
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_S_HIN
        data_type: VARCHAR(16777216)
      - name: HCP_S_MA_ID
        description: Healthcare provider master agreement identifier.
        expr: HCP_S_MA_ID
        data_type: VARCHAR(16777216)
        sample_values:
          - '381767'
          - '808700'
          - '469231'
      - name: HCP_S_NPI_NUM
        description: National Provider Identifier number for healthcare providers.
        expr: HCP_S_NPI_NUM
        data_type: VARCHAR(16777216)
        sample_values:
          - '1003443490'
          - '1396321816'
          - '1295437895'
      - name: HCP_S_STATE_LIC_NUM
        description: State license numbers for healthcare providers.
        expr: HCP_S_STATE_LIC_NUM
        data_type: VARCHAR(16777216)
        sample_values:
          - RN528086L
          - 053978-23
          - '22566'
      - name: HCP_S_STATE_LIC_STATE_CD
        description: State code where the healthcare provider holds their professional license.
        expr: HCP_S_STATE_LIC_STATE_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - CT
          - WI
      - name: HCP_S_STATE_LIC_STATUS
        description: The status of a healthcare provider's state license.
        expr: HCP_S_STATE_LIC_STATUS
        data_type: VARCHAR(16777216)
        sample_values:
          - PROBATION
          - ACTIVE
      - name: HCP_SRC_ID_10_IMS2
        description: Healthcare provider source identifier from IMS database system.
        expr: HCP_SRC_ID_10_IMS2
        data_type: VARCHAR(16777216)
        sample_values:
          - '7692967'
          - '24968143'
          - '8098879'
      - name: HCP_SRC_ID_3_SCRUB
        description: Healthcare provider source identifier from the third data source after data scrubbing processes.
        expr: HCP_SRC_ID_3_SCRUB
        data_type: VARCHAR(16777216)
        sample_values:
          - WUSM01621661
          - WUSR06017841
          - WUSP00548392
      - name: HCP_SRC_ID_4_SFA
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_4_SFA
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_5_SFA
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_5_SFA
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_CF_SPDI
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_CF_SPDI
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_IMS
        description: Healthcare provider source identifier from IMS data system.
        expr: HCP_SRC_ID_IMS
        data_type: VARCHAR(16777216)
        sample_values:
          - '7182700'
          - '1292510'
          - '2851684'
      - name: HCP_SRC_ID_OH_TDDD
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_OH_TDDD
        data_type: VARCHAR(16777216)
        sample_values:
          - '020363900'
          - '021366000'
      - name: HCP_SRC_ID_P_CLIENT
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_P_CLIENT
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_P_COPROMO
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_P_COPROMO
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_P_SCRUB
        description: Healthcare provider source identifier after data scrubbing processes.
        expr: HCP_SRC_ID_P_SCRUB
        data_type: VARCHAR(16777216)
        sample_values:
          - '13322122'
          - '15733078'
      - name: HCP_SRC_ID_P_SFA
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_P_SFA
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_P_SP
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_P_SP
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_S_CLIENT
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_S_CLIENT
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_S_COPROMO
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_S_COPROMO
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_S_SCRUB
        description: Healthcare provider source identifier after data scrubbing processes.
        expr: HCP_SRC_ID_S_SCRUB
        data_type: VARCHAR(16777216)
        sample_values:
          - WUSM05200310
          - WUSM04669326
          - WUSM00017540
      - name: HCP_SRC_ID_S_SFA
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_S_SFA
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_S_SP
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_S_SP
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_SHA
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_SHA
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_T_COPROMO
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_T_COPROMO
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_T_SFA
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_T_SFA
        data_type: VARCHAR(16777216)
      - name: HCP_SRC_ID_T_SP
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_SRC_ID_T_SP
        data_type: VARCHAR(16777216)
      - name: HCP_SUFFIX
        description: Healthcare provider name suffix such as senior or junior designations.
        expr: HCP_SUFFIX
        data_type: VARCHAR(16777216)
        sample_values:
          - JR
          - II
          - SR
      - name: HCP_T_DEA_BUSINESS_ACTIVITY_CD
        description: Drug Enforcement Administration business activity code for healthcare providers.
        expr: HCP_T_DEA_BUSINESS_ACTIVITY_CD
        data_type: VARCHAR(16777216)
      - name: HCP_T_DEA_DRUG_SCHEDULE
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_T_DEA_DRUG_SCHEDULE
        data_type: VARCHAR(16777216)
      - name: HCP_T_DEA_LIC_STATUS_CD
        description: Healthcare provider Drug Enforcement Administration license status code.
        expr: HCP_T_DEA_LIC_STATUS_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - ACTIVE
      - name: HCP_T_DEA_NUM
        description: Drug Enforcement Administration number for healthcare providers.
        expr: HCP_T_DEA_NUM
        data_type: VARCHAR(16777216)
        sample_values:
          - FK9444655
          - FB3199975
      - name: HCP_T_DEA_STATE_OF_LICENSURE
        description: The state where the healthcare provider's Drug Enforcement Administration license was issued.
        expr: HCP_T_DEA_STATE_OF_LICENSURE
        data_type: VARCHAR(16777216)
        sample_values:
          - SD
          - TN
      - name: HCP_T_HIN
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_T_HIN
        data_type: VARCHAR(16777216)
      - name: HCP_T_MA_ID
        description: A column holding data of type VARCHAR(16777216).
        expr: HCP_T_MA_ID
        data_type: VARCHAR(16777216)
        sample_values:
          - '634359'
          - '526408'
      - name: HCP_T_NPI_NUM
        description: National Provider Identifier number for healthcare providers.
        expr: HCP_T_NPI_NUM
        data_type: VARCHAR(16777216)
      - name: HCP_T_STATE_LIC_NUM
        description: Healthcare provider state license numbers.
        expr: HCP_T_STATE_LIC_NUM
        data_type: VARCHAR(16777216)
        sample_values:
          - '0810007329'
          - '23410'
      - name: HCP_T_STATE_LIC_STATE_CD
        description: The state code where the healthcare provider holds their license.
        expr: HCP_T_STATE_LIC_STATE_CD
        data_type: VARCHAR(16777216)
        sample_values:
          - MD
          - FL
      - name: HCP_T_STATE_LIC_STATUS
        description: The status of a healthcare provider's state license.
        expr: HCP_T_STATE_LIC_STATUS
        data_type: VARCHAR(16777216)
        sample_values:
          - INACTIVE
          - ACTIVE
      - name: HCP_TITLE
        description: Healthcare provider professional title or designation.
        expr: HCP_TITLE
        data_type: VARCHAR(16777216)
      - name: KOL_IND
        description: Key opinion leader indicator flag.
        expr: KOL_IND
        data_type: VARCHAR(16777216)
      - name: NO_SEE_IND
        description: A column holding data of type VARCHAR(16777216).
        expr: NO_SEE_IND
        data_type: VARCHAR(16777216)
      - name: SAMPLEABILITY_IND
        description: An indicator of whether the healthcare provider can be sampled.
        expr: SAMPLEABILITY_IND
        data_type: VARCHAR(16777216)
    time_dimensions:
      - name: HCP_BIRTH_DT
        description: Healthcare provider birth dates.
        expr: HCP_BIRTH_DT
        data_type: DATE
        sample_values:
          - '1968-01-01'
          - '1971-01-01'
          - '1978-01-01'
      - name: HCP_P_DEA_EXP_DT
        description: The expiration date of the healthcare provider's Drug Enforcement Administration registration.
        expr: HCP_P_DEA_EXP_DT
        data_type: DATE
        sample_values:
          - '2028-01-31'
          - '2028-05-31'
          - '2027-02-28'
      - name: HCP_P_STATE_LIC_EXP_DT
        description: The expiration date of the healthcare provider's state license.
        expr: HCP_P_STATE_LIC_EXP_DT
        data_type: DATE
        sample_values:
          - '2027-08-31'
          - '2028-08-31'
          - '2025-11-30'
      - name: HCP_P_STATE_LIC_ISSUE_DT
        description: The date when the healthcare provider's state license was issued.
        expr: HCP_P_STATE_LIC_ISSUE_DT
        data_type: DATE
        sample_values:
          - '2022-07-01'
          - '2020-02-13'
          - '2024-06-23'
      - name: HCP_PDRP_OPTOUT_DT
        description: The date when a healthcare provider opted out of the Prescription Drug Reporting Program.
        expr: HCP_PDRP_OPTOUT_DT
        data_type: DATE
        sample_values:
          - '2008-12-04'
          - '2008-11-27'
      - name: HCP_S_DEA_EXP_DT
        description: The expiration date of the healthcare provider's Drug Enforcement Administration registration.
        expr: HCP_S_DEA_EXP_DT
        data_type: DATE
        sample_values:
          - '2026-07-31'
          - '2026-12-31'
          - '2026-03-31'
      - name: HCP_S_STATE_LIC_EXP_DT
        description: The expiration date of the healthcare provider's state license.
        expr: HCP_S_STATE_LIC_EXP_DT
        data_type: DATE
        sample_values:
          - '2026-04-05'
          - '2026-02-04'
          - '2027-03-01'
      - name: HCP_S_STATE_LIC_ISSUE_DT
        description: The date when the healthcare provider's state license was issued.
        expr: HCP_S_STATE_LIC_ISSUE_DT
        data_type: DATE
        sample_values:
          - '2019-04-23'
          - '2021-05-14'
      - name: HCP_T_DEA_EXP_DT
        description: The expiration date of the healthcare provider's Drug Enforcement Administration registration.
        expr: HCP_T_DEA_EXP_DT
        data_type: DATE
        sample_values:
          - '2028-04-30'
          - '2026-08-31'
          - '2027-10-31'
      - name: HCP_T_STATE_LIC_EXP_DT
        description: The expiration date of the healthcare provider's state license.
        expr: HCP_T_STATE_LIC_EXP_DT
        data_type: DATE
        sample_values:
          - '2026-10-31'
          - '2025-12-31'
          - '2026-09-30'
      - name: HCP_T_STATE_LIC_ISSUE_DT
        description: The date when the healthcare provider's state license was issued.
        expr: HCP_T_STATE_LIC_ISSUE_DT
        data_type: DATE
        sample_values:
          - '2002-05-08'
          - '2022-02-18'
      - name: SAMPLEABILITY_DT
        description: The date when sampleability status was determined or last updated.
        expr: SAMPLEABILITY_DT
        data_type: DATE
    facts:
      - name: HCP_STATUS_KEY
        description: Healthcare provider status identifier used as a foreign key reference.
        expr: HCP_STATUS_KEY
        data_type: NUMBER(38,0)
        access_modifier: public_access
        sample_values:
          - '1'
      - name: HCP_SUBTYPE_KEY
        description: Healthcare provider subtype identifier key.
        expr: HCP_SUBTYPE_KEY
        data_type: NUMBER(38,0)
        access_modifier: public_access
        sample_values:
          - '9'
          - '10'
          - '13'
    primary_key:
      columns:
        - HCP_KEY
  - name: TD_PROD_BRAND
    description: The table contains records of product brand and categorization information used for sales performance reporting. Each record represents a product hierarchy structure that includes market segments, category groupings, individual categories, family groupings, and product families with their corresponding identifiers and descriptions.
    base_table:
      database: DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB
      schema: REPORTING
      table: TD_PROD_BRAND
    dimensions:
      - name: PROD_BRAND_CD
        description: Product brand codes for pharmaceutical and medical products.
        expr: PROD_BRAND_CD
        data_type: VARCHAR(256)
        sample_values:
          - ANOLOR 300
          - CHILDRENS Q-PAP
          - TENCON
      - name: PROD_BRAND_DESC
        description: Brand names of pharmaceutical pain management products along with their associated market categories.
        expr: PROD_BRAND_DESC
        data_type: VARCHAR(256)
        sample_values:
          - BUFFERED ASPIRIN EXTRA S BRAND (VERTEX ACUTE MARKET)
          - LIDOPRIL XR BRAND (ACUTE HEOR MARKET)
          - RA ORASOL BRAND (VERTEX ACUTE MARKET)
      - name: PROD_BRAND_KEY
        description: A unique identifier key for product brands.
        expr: PROD_BRAND_KEY
        data_type: VARCHAR(32)
        sample_values:
          - a96f921f9adcf6357022ae1d77e0036e
          - 77238a2664c2da30f3763020cc9f64a1
          - a3013ea55958b130a8be56287a23ac84
      - name: PROD_BRAND_SDESC
        description: Product brand short description or name.
        expr: PROD_BRAND_SDESC
        data_type: VARCHAR(256)
        sample_values:
          - RECTASMOOTHE
          - LIDOVIX L
          - NUVAKAAN-II
      - name: PROD_BRAND_UCD
        description: Brand names of pharmaceutical and over-the-counter medical products.
        expr: PROD_BRAND_UCD
        data_type: VARCHAR(256)
        sample_values:
          - CAPSAICIN TOPICAL PAIN P
          - PAIN-EZE PLUS
          - PRILO PATCH II
      - name: PROD_CAT_CD
        description: Pharmaceutical product category codes indicating the therapeutic classification of medical products.
        expr: PROD_CAT_CD
        data_type: VARCHAR(256)
        sample_values:
          - DERMATOLOGICAL TOPICAL ANESTHETIC COMBINATIONS
          - LIDOCAINE - ANESTHETIC
          - AMIDES
      - name: PROD_CAT_DESC
        description: Product category descriptions for pharmaceutical pain management treatments.
        expr: PROD_CAT_DESC
        data_type: VARCHAR(256)
        sample_values:
          - ANALGESICS-SEDATIVE COMBINATION CATEGORY (ANY PAIN MARKET)
          - LIDOCAINE - ANESTHETIC CATEGORY (VERTEX ACUTE MARKET)
          - DENTAL LOCAL ANESTHETIC CATEGORY (ANY PAIN MARKET)
      - name: PROD_CAT_KEY
        description: A unique identifier key for product categories.
        expr: PROD_CAT_KEY
        data_type: VARCHAR(32)
        sample_values:
          - 12bc423a463b94db26c110a7b5f35c2b
          - 51d89477c08fab581269b5cd07cc9249
          - 6cdf4a9156745f9ceab6a9d55493f62f
      - name: PROD_CAT_SDESC
        description: Product category short descriptions for pharmaceutical and medical products.
        expr: PROD_CAT_SDESC
        data_type: VARCHAR(256)
        sample_values:
          - RHEUMATOID ARTHRITIS
          - DERMATOLOGICAL TOPICAL ANESTHETIC
          - SSRI
      - name: PROD_CATGRP_CD
        description: Product category group codes representing different pharmaceutical and medical product classifications.
        expr: PROD_CATGRP_CD
        data_type: VARCHAR(256)
        sample_values:
          - OSTEOARTHRITIS
          - ANESTHETIC
          - DENTALS
      - name: PROD_CATGRP_DESC
        description: Product category group descriptions for pharmaceutical products in acute care markets.
        expr: PROD_CATGRP_DESC
        data_type: VARCHAR(256)
        sample_values:
          - OTHER CATEGORY GROUP (ANY PAIN MARKET)
          - DERMATOLOGICAL CATEGORY GROUP (VERTEX ACUTE MARKET)
          - NON-NARCOTIC ANALGESIC CATEGORY GROUP (VERTEX ACUTE MARKET)
      - name: PROD_CATGRP_KEY
        description: A unique identifier key for product category groups.
        expr: PROD_CATGRP_KEY
        data_type: VARCHAR(32)
        sample_values:
          - ae4d74c1255ef3b525bf3ee4914ed273
          - a9946aba572bb08c111e94c3c36c84f7
          - d8cad3b14468ba5121e210028e133b00
      - name: PROD_CATGRP_SDESC
        description: Product category group short description indicating the therapeutic classification or type of pharmaceutical product.
        expr: PROD_CATGRP_SDESC
        data_type: VARCHAR(256)
        sample_values:
          - ANESTHETIC
          - DENTALS
          - NON-NARCOTIC ANALGESIC
      - name: PROD_FAM_CD
        description: Product family codes used to categorize and group related products.
        expr: PROD_FAM_CD
        data_type: VARCHAR(256)
        sample_values:
          - HYCOGESIC
          - PAMPRIN
          - ENDOLOR
      - name: PROD_FAM_DESC
        description: Product family descriptions for pain relief medications and treatments.
        expr: PROD_FAM_DESC
        data_type: VARCHAR(256)
        sample_values:
          - EFFEXOR XR FAMILY (ACUTE HEOR MARKET)
          - ENDOLOR FAMILY (ANY PAIN MARKET)
          - DYNAMIC FAMILY (ANY PAIN MARKET)
      - name: PROD_FAM_KEY
        description: A unique identifier key for product families.
        expr: PROD_FAM_KEY
        data_type: VARCHAR(32)
        sample_values:
          - 10738f1513e6f471c10da189c7b6db7c
          - 5e208a4effc1cd0786bed71851c6964f
          - 1ab075c96c0468e9796a665631ad472e
      - name: PROD_FAM_SDESC
        description: Pharmaceutical product family short descriptions or names.
        expr: PROD_FAM_SDESC
        data_type: VARCHAR(256)
        sample_values:
          - CHLORASEPTIC SR THRT
          - CHILDRENS Q-PAP
          - SYNOFLEX
      - name: PROD_FAMGRP_CD
        description: Active pharmaceutical ingredients or drug compounds used in pain management products.
        expr: PROD_FAMGRP_CD
        data_type: VARCHAR(256)
        sample_values:
          - CAPSAICIN-MENTHOL - DERMATOLOGICAL TOPICAL ANESTHETIC COMBINATIONS
          - HYDROCODONE
          - BENZOCAINE-ZINC CHLORIDE
      - name: PROD_FAMGRP_DESC
        description: Pharmaceutical product family group descriptions indicating drug types and their associated pain market categories.
        expr: PROD_FAMGRP_DESC
        data_type: VARCHAR(256)
        sample_values:
          - CAPSAICIN FAMILY GROUP (ANY PAIN MARKET)
          - BENZOCAINE-ZINC CHLORIDE FAMILY GROUP (ANY PAIN MARKET)
          - OXYCODONE COMBINATIONS FAMILY GROUP (ACUTE HEOR MARKET)
      - name: PROD_FAMGRP_KEY
        description: A unique identifier key for product family groups represented as a hash value.
        expr: PROD_FAMGRP_KEY
        data_type: VARCHAR(32)
        sample_values:
          - e86d9067df720cbe38d87f1d1e6ba4bb
          - 2d8609830dfd91355e0f57b69a124265
          - 2c25349bf27be50f2527bb0084f0f4d2
      - name: PROD_FAMGRP_SDESC
        description: Pharmaceutical product family group short descriptions indicating the active ingredient or drug category.
        expr: PROD_FAMGRP_SDESC
        data_type: VARCHAR(256)
        sample_values:
          - DESIPRAMINE
          - BENZOCAINE - DERMATOLOGICAL TOPICAL ANESTHETIC COMBINATIONS
          - LIDOCAINE - DERMATOLOGICAL TOPICAL ANESTHETIC COMBINATIONS
      - name: PROD_MKT_CD
        description: Product marketing code identifying the specific marketing category or segment for the product brand.
        expr: PROD_MKT_CD
        data_type: VARCHAR(256)
        sample_values:
          - ACUTE HEOR
          - ANY PAIN
          - VERTEX ACUTE
      - name: PROD_MKT_DESC
        description: Product market description indicating the specific market segment or category for the product.
        expr: PROD_MKT_DESC
        data_type: VARCHAR(256)
        sample_values:
          - VERTEX ACUTE MARKET
          - ACUTE HEOR MARKET
          - ANY PAIN MARKET
      - name: PROD_MKT_KEY
        description: A unique marketing key identifier for products.
        expr: PROD_MKT_KEY
        data_type: VARCHAR(32)
        sample_values:
          - da0dacac9831661226335a3eb0b04274
          - 89cf3596760b4a79df67736f2272a1b7
          - c8c606d1c69b2144eea5bbe3157289b6
      - name: PROD_MKT_SDESC
        description: Product marketing short description for pharmaceutical pain management brands.
        expr: PROD_MKT_SDESC
        data_type: VARCHAR(256)
        sample_values:
          - ACUTE HEOR
          - ANY PAIN
          - VERTEX ACUTE
    primary_key:
      columns:
        - PROD_BRAND_KEY
  - name: TM_ARD_HCP_ACUTE_MKT_WEEKLY_XPO
    description: The table contains records of healthcare provider prescription activity in acute care settings, tracked on a weekly basis. Each record represents prescription exposure data for a specific healthcare provider and includes provider identifiers, specialty information, territorial assignments, and prescription metrics for acute care treatments.
    base_table:
      database: DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB
      schema: REPORTING
      table: TM_ARD_HCP_ACUTE_MKT_WEEKLY_XPO
    dimensions:
      - name: BRANDED_FLAG
        description: A flag indicating whether the product is branded or not.
        expr: BRANDED_FLAG
        data_type: VARCHAR(16777216)
        sample_values:
          - 'N'
          - 'Y'
      - name: GOLDEN_ID
        description: A unique identifier used to link and track healthcare providers across different systems and databases.
        expr: GOLDEN_ID
        data_type: VARCHAR(16777216)
        sample_values:
          - GLD000600060001002101
          - GLD999900180020002401
          - GLD021402140287037101
      - name: HCP_ID
        description: Unique identifier for healthcare providers.
        expr: HCP_ID
        data_type: VARCHAR(32)
        sample_values:
          - b53fb88ce1b284c55206728afb2a9da6
          - e32c570ee80606057196f62cf5b6e502
          - 132c4377c0b6eee2172aefb7d046b30e
      - name: HCP_SPECIALTY
        description: Medical specialty or practice area of the healthcare provider.
        expr: HCP_SPECIALTY
        data_type: VARCHAR(16777216)
        sample_values:
          - ADULT RECONSTRUCTIVE ORTHOPEDICS
          - EMERGENCY MEDICINE
          - DENTIST
      - name: HCP_SPECIALTY_GROUP
        description: Healthcare provider specialty groups categorizing medical professionals by their area of practice.
        expr: HCP_SPECIALTY_GROUP
        data_type: VARCHAR(16777216)
        sample_values:
          - MEDICINE
          - PHYSICIAN EXTENDERS
          - ORTHOPEDICS AND SPORTS MEDICINE
      - name: NPI
        description: National Provider Identifier numbers for healthcare providers.
        expr: NPI
        data_type: VARCHAR(16777216)
        sample_values:
          - '1194281006'
          - '1659465573'
          - '1396203352'
      - name: ONEKEY_HCP_ID
        description: Unique identifier for healthcare providers in the OneKey system.
        expr: ONEKEY_HCP_ID
        data_type: VARCHAR(16777216)
        sample_values:
          - WUSD00201756
          - WUSM00530772
          - WUSM00311233
      - name: PRODUCT_CATEGORY
        description: Categories of pharmaceutical products used for pain management and treatment.
        expr: PRODUCT_CATEGORY
        data_type: VARCHAR(256)
        sample_values:
          - NSAID
          - STRONG OPIOID AGONIST
          - ANTICONVULSANTS MISC.
      - name: PRODUCT_FAMILY_GROUP
        description: Pharmaceutical product family groups categorizing related medications and therapeutic compounds.
        expr: PRODUCT_FAMILY_GROUP
        data_type: VARCHAR(256)
        sample_values:
          - LIDOCAINE - DERMATOLOGICAL LOCAL TOPICAL ANESTHETIC
          - MELOXICAM
          - HYDROCODONE COMBINATIONS
      - name: PTAM_TERRITORY_ID
        description: Unique identifier for a PTAM (Pain Territory Account Manager) territory.
        expr: PTAM_TERRITORY_ID
        data_type: VARCHAR(255)
        sample_values:
          - V1NAUSA-5733101
          - V1NAUSA-5733602
          - V1NAUSA-5733604
      - name: ROA
        description: Route of administration for pharmaceutical products.
        expr: ROA
        data_type: VARCHAR(256)
        sample_values:
          - ORAL
          - TOPICAL
          - TOPICAL-PATCH
      - name: SAL_TERRITORY_ID
        description: Sales territory identifier used to designate specific geographic or organizational sales regions.
        expr: SAL_TERRITORY_ID
        data_type: VARCHAR(255)
        sample_values:
          - V1NAUSA-5720008
          - V1NAUSA-5720014
      - name: SITE_OF_CARE_ZIP_CODE
        description: ZIP codes for healthcare facility locations.
        expr: SITE_OF_CARE_ZIP_CODE
        data_type: VARCHAR(16777216)
        sample_values:
          - '73118'
          - '43228'
          - '37027'
      - name: VERTEX_ID
        description: Unique identifier for a vertex in the healthcare provider network.
        expr: VERTEX_ID
        data_type: VARCHAR(16777216)
        sample_values:
          - '15670811'
          - '14499271'
      - name: ZIP_CODE
        description: Postal ZIP codes for geographic locations.
        expr: ZIP_CODE
        data_type: VARCHAR(16777216)
        sample_values:
          - '20850'
          - '33912'
          - '90262'
    time_dimensions:
      - name: DATE_KEY
        description: The date associated with each record in the healthcare provider acute market weekly exposure data.
        expr: DATE_KEY
        data_type: DATE
        sample_values:
          - '2024-05-17'
          - '2024-12-06'
          - '2025-02-07'
    facts:
      - name: ACUTE_NRX_XPO
        description: Acute new prescription exposure index for healthcare providers in the market.
        expr: ACUTE_NRX_XPO
        data_type: NUMBER(38,10)
        access_modifier: public_access
        sample_values:
          - '2.0320000000'
          - '0.9650000000'
          - '1.0420000000'
      - name: ACUTE_TRX_XPO
        description: Acute transaction exposure metric for healthcare providers in the market.
        expr: ACUTE_TRX_XPO
        data_type: NUMBER(38,10)
        access_modifier: public_access
        sample_values:
          - '1.6080000000'
          - '1.0300000000'
          - '0.9630000000'
      - name: ACUTE_TX_DAYS_XPO
        description: The number of days of acute treatment exposure.
        expr: ACUTE_TX_DAYS_XPO
        data_type: NUMBER(38,10)
        access_modifier: public_access
        sample_values:
          - '4.2033678514'
          - '3.2592136056'
          - '24.4437444312'
      - name: ACUTE_UNITS_XPO
        description: Acute care units exposure metric.
        expr: ACUTE_UNITS_XPO
        data_type: NUMBER(38,10)
        access_modifier: public_access
        sample_values:
          - '61.1900000000'
          - '160.0900000000'
          - '30.0000000000'
      - name: WEEK_DT
        description: The date representing a specific week in the healthcare provider acute market reporting period.
        expr: WEEK_DT
        data_type: NUMBER(10,0)
        access_modifier: public_access
        sample_values:
          - '20251024'
          - '20241220'
          - '20250321'
relationships:
  # Relationship between Weekly LAAD Facts and HCP Dimension
  - name: laad_weekly_to_hcp
    left_table: ARD_GIACO_TM_HCP_ACUTE_MKT_WEEKLY_LAAD
    right_table: TD_HCP
    relationship_columns:
      - left_column: HCP_ID
        right_column: HCP_KEY
    join_type: left_outer
    relationship_type: many_to_one

  # Relationship between Weekly Exposure (XPO) Facts and HCP Dimension
  - name: xpo_weekly_to_hcp
    left_table: TM_ARD_HCP_ACUTE_MKT_WEEKLY_XPO
    right_table: TD_HCP
    relationship_columns:
      - left_column: HCP_ID
        right_column: HCP_KEY
    join_type: left_outer
    relationship_type: many_to_one

  # Relationship between Weekly LAAD Facts and Postal Geography
  # Connecting via ZIP Code as the common identifier
  - name: laad_weekly_to_postal
    left_table: ARD_GIACO_TM_HCP_ACUTE_MKT_WEEKLY_LAAD
    right_table: TD_GEO_POSTAL
    relationship_columns:
      - left_column: ZIP_CODE
        right_column: GEO_POSTAL_CD
    join_type: left_outer
    relationship_type: many_to_one

  # Relationship between Weekly Exposure (XPO) Facts and Postal Geography
  # Connecting via ZIP Code as the common identifier
  - name: xpo_weekly_to_postal
    left_table: TM_ARD_HCP_ACUTE_MKT_WEEKLY_XPO
    right_table: TD_GEO_POSTAL
    relationship_columns:
      - left_column: ZIP_CODE
        right_column: GEO_POSTAL_CD
    join_type: left_outer
    relationship_type: many_to_one

  # Relationship between Cities and States (Geographic Hierarchy)
  - name: city_to_state
    left_table: TD_GEO_CITY
    right_table: TD_GEO_STATE
    relationship_columns:
      - left_column: GEO_STATE_KEY
        right_column: GEO_STATE_KEY
    join_type: left_outer
    relationship_type: many_to_one

  # Relationship between Postal Codes and States (Geographic Hierarchy)
  - name: postal_to_state
    left_table: TD_GEO_POSTAL
    right_table: TD_GEO_STATE
    relationship_columns:
      - left_column: GEO_STATE_KEY
        right_column: GEO_STATE_KEY
    join_type: left_outer
    relationship_type: many_to_one

  # Relationship between Specific Locations and Cities (Geographic Hierarchy)
  - name: location_to_city
    left_table: TD_GEO_LOC
    right_table: TD_GEO_CITY
    relationship_columns:
      - left_column: GEO_CITY_KEY
        right_column: GEO_CITY_KEY
    join_type: left_outer
    relationship_type: many_to_one

  # Relationship between Specific Locations and Postal Codes (Geographic Hierarchy)
  - name: location_to_postal
    left_table: TD_GEO_LOC
    right_table: TD_GEO_POSTAL
    relationship_columns:
      - left_column: GEO_POSTAL_KEY
        right_column: GEO_POSTAL_KEY
    join_type: left_outer
    relationship_type: many_to_one

  # Relationship between Specific Locations and States (Geographic Hierarchy)
  - name: location_to_state
    left_table: TD_GEO_LOC
    right_table: TD_GEO_STATE
    relationship_columns:
      - left_column: GEO_STATE_KEY
        right_column: GEO_STATE_KEY
    join_type: left_outer
    relationship_type: many_to_one
def main(session: Session, user_query: str, parent_node_ids_json: str, tree_id: str = ''Pharma_Master_v1''):
    try:
        log_debug(session, "MAIN_ENTRY", f"TreeID: {tree_id}, Query: {user_query}")

        # 1. Load Decision Tree Structure
        tree_row = session.sql("SELECT GRAPH_JSON FROM DECISION_TREE_STORE_NEW WHERE TREE_ID = ?", params=[tree_id]).collect()
        
        if not tree_row: 
            return json.dumps({"error": f"Tree ID not found: {tree_id}"})
        
        full_json = json.loads(tree_row[0][''GRAPH_JSON''])
        graph = full_json.get(''graph'', full_json)
        
        # Build Lookup Maps
        all_nodes_map = {n[''id'']: n for n in graph.get(''nodes'', [])}
        name_to_node_map = {n[''metric'']: n for n in graph.get(''nodes'', [])}
        all_edges = graph.get(''edges'', [])

        # 2. Determine Strategy (Search vs Drill)
        targets_phase_1 = []
        
        # Robust Null Check
        is_drill_mode = (
            parent_node_ids_json is not None and 
            parent_node_ids_json != '''' and 
            parent_node_ids_json.upper() != ''NULL'' and 
            parent_node_ids_json != ''[]''
        )

        if not is_drill_mode and user_query:
            log_debug(session, "STRATEGY", "Vector Search (No parent IDs provided)")
            # Vector Search for Entry Point
            vec_sql = """
            SELECT METRIC_NAME FROM KPI_KNOWLEDGE_BASE_NEW 
            ORDER BY VECTOR_L2_DISTANCE(SNOWFLAKE.CORTEX.EMBED_TEXT_768(''snowflake-arctic-embed-m-v1.5'', ?), KPI_EMBEDDING) ASC 
            LIMIT 1
            """
            kb_row = session.sql(vec_sql, params=[user_query]).collect()
            if kb_row and kb_row[0][''METRIC_NAME''] in name_to_node_map:
                found_metric = kb_row[0][''METRIC_NAME'']
                targets_phase_1.append(name_to_node_map[found_metric])
                log_debug(session, "ANCHOR_FOUND", f"Matched: {found_metric}")

        elif is_drill_mode:
            log_debug(session, "STRATEGY", "Drill Down (Parent IDs provided)")
            try:
                p_ids = json.loads(parent_node_ids_json)
                if not isinstance(p_ids, list): p_ids = [p_ids]
                parent_set = set(p_ids)
                
                # Find children of provided parents
                for edge in all_edges:
                    if edge[''source''] in all_nodes_map and edge[''target''] in parent_set:
                         # Note: Depending on edge direction (source->target), adjust accordingly.
                         # Assuming Source=Parent, Target=Child? Or Source=Metric, Target=Root?
                         # Usually standard DAG is Parent -> Child. 
                         # If input is ''Parent Nodes'', we want their children.
                         # CHECK: Your previous code checked ''target'' in parent_set. 
                         # If Edge is Source(Parent)->Target(Child), then Target in ParentSet means we are looking for parents?
                         # Let''s assume the previous logic was correct: "Find nodes connected to these parents"
                         if edge[''target''] in parent_set:
                             targets_phase_1.append(all_nodes_map[edge[''source'']])
            except Exception as e:
                log_debug(session, "DRILL_ERROR", str(e))

        # 3. Execute Phase 1 (Entry Nodes)
        results_phase_1 = execute_batch(session, targets_phase_1, user_query)

        # 4. Execute Phase 2 (Greedy Traversal of "Bad" Nodes)
        bad_ids = {r[''id''] for r in results_phase_1 if r.get(''status'') == ''bad''}
        targets_phase_2 = []
        
        if bad_ids:
            log_debug(session, "PHASE_2", f"Expanding bad nodes: {list(bad_ids)}")
            for edge in all_edges:
                # If a node was bad, check its relationships
                if edge[''target''] in bad_ids and edge[''source''] in all_nodes_map:
                    targets_phase_2.append(all_nodes_map[edge[''source'']])
        
        results_phase_2 = execute_batch(session, targets_phase_2, user_query)

        # 5. Final Output
        return json.dumps({
            "nodes_analyzed": results_phase_1 + results_phase_2,
            "edges_traversed": [e for e in all_edges if e[''target''] in bad_ids or e[''source''] in bad_ids]
        })

    except Exception as e:
        log_debug(session, "MAIN_CRASH", str(e))
        return json.dumps({"error": "Critical Procedure Error", "details": str(e), "trace": traceback.format_exc()})
';
    left_table: TD_HCO
    right_table: TD_HCO_SUBTYPE
    relationship_columns:
      - left_column: HCO_SUBTYPE_KEY
        right_column: HCO_SUBTYPE_KEY
    join_type: left_outer
    relationship_type: many_to_one
-- 1. Create the Raw Load Table
CREATE OR REPLACE TABLE RAW_PHARMA_SALES (
    ONEKEY_ID VARCHAR(50),
    HCP_ID VARCHAR(50),
    HCP_ZIP_CODE VARCHAR(20),
    TERRITORY_ID VARCHAR(50),
    HCO_NAME VARCHAR(255),
    HCP_NAME VARCHAR(255),
    PRIMARY_SPECIALTY_METRIC VARCHAR(255),
    HCP_STATE VARCHAR(50),
    HCP_CITY VARCHAR(100),
    ID VARCHAR(50),
    GEO_STATE_CD VARCHAR(10),
    GEO_CITY_NAME VARCHAR(100),
    LOC_ADDR_LINE_1 VARCHAR(255),
    LOC_ADDR_LINE_2 VARCHAR(255),
    LOC_ADDR_LINE_3 VARCHAR(255),
    PTAM_TERRITORY_ID VARCHAR(50),
    PROD_FAMGRP_CD VARCHAR(50),
    PROD_CATGRP_CD VARCHAR(50),
    PRODUCT_FAMILY_GROUP VARCHAR(100),
    PRODUCT_CATEGORY VARCHAR(100),
    ACUTE_TRX_LAAD NUMBER,
    ACUTE_NRX_XPO NUMBER,
    ACUTE_TRX_XPO NUMBER,
    HCO_NAME_2 VARCHAR(255),
    HCO_SUBTYPE_CD VARCHAR(50)
);
COPY INTO RAW_PHARMA_SALES
FROM'@"DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB"."AI_POC"."MY_EXCEL_STAGE"/data_sample.csv'
FILE_FORMAT = (TYPE = 'CSV' FIELD_OPTIONALLY_ENCLOSED_BY = '"' SKIP_HEADER = 1)
ON_ERROR = 'CONTINUE'; -- Keeps loading even if a few rows have errors
-- 2. Create the Requested View
CREATE OR REPLACE VIEW MASTER_DB_SAMPLE_DATA AS 
SELECT * FROM RAW_PHARMA_SALES;

-- 3. Clear Previous Knowledge Base Data
TRUNCATE TABLE KPI_KNOWLEDGE_BASE_NEW;
TRUNCATE TABLE DECISION_TREE_STORE_NEW;

INSERT INTO KPI_KNOWLEDGE_BASE_NEW (KPI_ID, METRIC_NAME, DESCRIPTION, SQL_QUERY, FEW_SHOT_EXAMPLES, KPI_EMBEDDING)

-- LEVEL 1: Market & Totals
SELECT 'K1', 'Total Market Volume (TRX)', 'Total volume of all acute prescriptions across the entire market.', 
'SELECT SUM(ACUTE_TRX_XPO) FROM MASTER_DB_SAMPLE_DATA', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'Total Market Volume TRX all sales')

UNION ALL
SELECT 'K2', 'Total New Starts (NRX)', 'Total volume of new-to-therapy prescriptions, indicating market growth.', 
'SELECT SUM(ACUTE_NRX_XPO) FROM MASTER_DB_SAMPLE_DATA', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'Total New Starts NRX growth')

-- LEVEL 2: Categories
UNION ALL
SELECT 'K3', 'Opioid Category Volume', 'Total prescriptions for the Opioid drug class (e.g., Tramadol).', 
'SELECT SUM(ACUTE_TRX_XPO) FROM MASTER_DB_SAMPLE_DATA WHERE PRODUCT_CATEGORY = ''OPIOID''', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'Opioid Category Volume pain meds')

UNION ALL
SELECT 'K4', 'NSAID Category Volume', 'Total prescriptions for the NSAID drug class (e.g., Diclofenac).', 
'SELECT SUM(ACUTE_TRX_XPO) FROM MASTER_DB_SAMPLE_DATA WHERE PRODUCT_CATEGORY = ''NSAID''', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'NSAID Category Volume anti inflammatory')

-- LEVEL 3: Products
UNION ALL
SELECT 'K5', 'Tramadol Brand Volume', 'Total prescriptions specifically for the Tramadol product family.', 
'SELECT SUM(ACUTE_TRX_XPO) FROM MASTER_DB_SAMPLE_DATA WHERE PRODUCT_FAMILY_GROUP = ''TRAMADOL''', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'Tramadol Brand Volume product specific')

UNION ALL
SELECT 'K6', 'Diclofenac Brand Volume', 'Total prescriptions specifically for the Diclofenac product family.', 
'SELECT SUM(ACUTE_TRX_XPO) FROM MASTER_DB_SAMPLE_DATA WHERE PRODUCT_FAMILY_GROUP = ''DICLOFENAC''', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'Diclofenac Brand Volume product specific')

-- LEVEL 4: Product Performance Metrics (New vs Refill)
UNION ALL
SELECT 'K7', 'Tramadol New Growth (NRX)', 'New patient prescriptions for Tramadol. Key indicator of sales force effectiveness.', 
'SELECT SUM(ACUTE_NRX_XPO) FROM MASTER_DB_SAMPLE_DATA WHERE PRODUCT_FAMILY_GROUP = ''TRAMADOL''', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'Tramadol New Growth NRX new patients')

UNION ALL
SELECT 'K8', 'Tramadol Retention (Refills)', 'Volume of Tramadol refills (TRX minus NRX), indicating patient retention.', 
'SELECT SUM(ACUTE_TRX_XPO) - SUM(ACUTE_NRX_XPO) FROM MASTER_DB_SAMPLE_DATA WHERE PRODUCT_FAMILY_GROUP = ''TRAMADOL''', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'Tramadol Retention Refills loyal patients')

UNION ALL
SELECT 'K9', 'Diclofenac New Growth (NRX)', 'New patient prescriptions for Diclofenac.', 
'SELECT SUM(ACUTE_NRX_XPO) FROM MASTER_DB_SAMPLE_DATA WHERE PRODUCT_FAMILY_GROUP = ''DICLOFENAC''', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'Diclofenac New Growth NRX')

-- LEVEL 5: Specialist & Geography Segments
UNION ALL
SELECT 'K10', 'Orthopedic Tramadol Starts', 'New Tramadol prescriptions written specifically by Orthopedic Surgeons.', 
'SELECT SUM(ACUTE_NRX_XPO) FROM MASTER_DB_SAMPLE_DATA WHERE PRODUCT_FAMILY_GROUP = ''TRAMADOL'' AND PRIMARY_SPECIALTY_METRIC LIKE ''%Orthopedic%''', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'Orthopedic Tramadol Starts surgeon new rx')

UNION ALL
SELECT 'K11', 'PCP Tramadol Starts', 'New Tramadol prescriptions written by Primary Care/Internal Medicine.', 
'SELECT SUM(ACUTE_NRX_XPO) FROM MASTER_DB_SAMPLE_DATA WHERE PRODUCT_FAMILY_GROUP = ''TRAMADOL'' AND PRIMARY_SPECIALTY_METRIC IN (''Other PCP Specialties'', ''Internal Medicine'')', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'PCP Tramadol Starts primary care')

UNION ALL
SELECT 'K12', 'NC Market Volume', 'Total prescription volume in North Carolina, a key territory.', 
'SELECT SUM(ACUTE_TRX_XPO) FROM MASTER_DB_SAMPLE_DATA WHERE HCP_STATE = ''NC''', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'NC Market Volume north carolina state')

UNION ALL
SELECT 'K13', 'AR Market Volume', 'Total prescription volume in Arkansas.', 
'SELECT SUM(ACUTE_TRX_XPO) FROM MASTER_DB_SAMPLE_DATA WHERE HCP_STATE = ''AR''', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'AR Market Volume arkansas state')

UNION ALL
SELECT 'K14', 'High Volume Writers (>10)', 'Prescriptions coming from HCPs with more than 10 total scripts.', 
'SELECT SUM(ACUTE_TRX_XPO) FROM MASTER_DB_SAMPLE_DATA WHERE ACUTE_TRX_XPO > 10', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'High Volume Writers top prescribers')

UNION ALL
SELECT 'K15', 'NP/PA Segment Contribution', 'Volume generated by Nurse Practitioners and Physician Assistants.', 
'SELECT SUM(ACUTE_TRX_XPO) FROM MASTER_DB_SAMPLE_DATA WHERE PRIMARY_SPECIALTY_METRIC = ''NP/PA''', 
PARSE_JSON('[]'), SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', 'NP PA Segment Contribution nurse practitioner');


INSERT INTO DECISION_TREE_STORE_NEW (TREE_ID, GRAPH_JSON) 
SELECT 'Pharma_Master_v1', PARSE_JSON($$
{
    "graph": {
        "nodes": [
            { "id": "K1", "metric": "Total Market Volume (TRX)" },
            { "id": "K2", "metric": "Total New Starts (NRX)" },
            { "id": "K3", "metric": "Opioid Category Volume" },
            { "id": "K4", "metric": "NSAID Category Volume" },
            { "id": "K5", "metric": "Tramadol Brand Volume" },
            { "id": "K6", "metric": "Diclofenac Brand Volume" },
            { "id": "K7", "metric": "Tramadol New Growth (NRX)" },
            { "id": "K8", "metric": "Tramadol Retention (Refills)" },
            { "id": "K9", "metric": "Diclofenac New Growth (NRX)" },
            { "id": "K10", "metric": "Orthopedic Tramadol Starts" },
            { "id": "K11", "metric": "PCP Tramadol Starts" },
            { "id": "K12", "metric": "NC Market Volume" },
            { "id": "K13", "metric": "AR Market Volume" },
            { "id": "K14", "metric": "High Volume Writers (>10)" },
            { "id": "K15", "metric": "NP/PA Segment Contribution" }
        ],
        "edges": [
            { "source": "K3", "target": "K1" }, 
            { "source": "K4", "target": "K1" }, 
            { "source": "K5", "target": "K3" }, 
            { "source": "K6", "target": "K4" }, 
            { "source": "K7", "target": "K5" }, 
            { "source": "K8", "target": "K5" }, 
            { "source": "K9", "target": "K6" }, 
            { "source": "K10", "target": "K7" }, 
            { "source": "K11", "target": "K7" }, 
            { "source": "K15", "target": "K4" }
        ]




  import _snowflake
import json
import time
import snowflake.snowpark as snowpark
from snowflake.snowpark.exceptions import SnowparkSQLException

# ==========================================
# HELPER 1: FAST FEEDBACK SUBMISSION (SQL)
# ==========================================
def submit_feedback_sql(session: snowpark.Session, user_id: str, text: str, is_positive: bool):
    try:
        # Simple SQL-safe string escape
        clean_text = text.replace("'", "''")
        query = f"""
            INSERT INTO feedback_staging 
            (user_id, feedback_text, feedback_rating)
            VALUES ('{user_id}', '{clean_text}', {is_positive})
        """
        session.sql(query).collect()
        print(f" Feedback submitted for: {user_id}")
    except Exception as e:
        print(f" Submit Error: {e}")

# ==========================================
# HELPER 2: CALL AGENT VIA INTERNAL API
# ==========================================
def call_cortex_agent_internal(session: snowpark.Session, user_id: str, user_query: str):
    print(f"\n--- Calling Agent for {user_id} ---")
    
    # --- CONFIGURATION ---
    # Endpoint for stateless agent execution
    AGENT_ENDPOINT_URL = f"/api/v2/databases/''DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB''/schemas/''AI_POC''/agent/''FEEDBACK_TEST'':run"
    TIMEOUT_MS = 180_000 # 3 minutes

    # 1. Retrieve Memory (Fast Lookup)
    try:
        mem_df = session.sql(f"SELECT current_summary FROM user_memory WHERE user_id = '{user_id}'").collect()
        retrieved_memory = mem_df[0]['CURRENT_SUMMARY'] if mem_df and mem_df[0]['CURRENT_SUMMARY'] else "No prior context."
        print(f" Memory Found: {len(retrieved_memory) > 20} (Length: {len(retrieved_memory)})")
    except:
         retrieved_memory = "No prior context."

    # 2. Define Instructions
    # Logic rules for the "brain"
    orchestration_rules = """
    You are a helpful corporate analyst agent.
    - Never fabricate data.
    - If you use a tool to get data, rely ONLY on that data.
    - CRITICAL: You must adhere to the USER CONTEXT provided below in your logic.
    """
    # Style rules for the "voice"
    response_rules = """
    - Be professional and concise.
    - Use Markdown for formatting.
    """

    # 3. Construct the Payload (using AgentInstruction schema)
    # We inject the retrieved memory directly into the orchestration block.
    payload = {
        "model": "claude-3-5-sonnet", # Or your preferred supported model
        "instructions": {
            "orchestration": f"{orchestration_rules}\n\n### USER CONTEXT ###\n{retrieved_memory}",
            "response": response_rules
        },
        "messages": [
            {"role": "user", "content": [{"type": "text", "text": user_query}]}
        ],
        "stream": False
    }

    # Headers for internal API call
    headers = {
        "Content-Type": "application/json",
        "Accept": "application/json"
    }

    # 4. Make the internal API request
    try:
        response_dict = _snowflake.send_snow_api_request(
            "POST",
            AGENT_ENDPOINT_URL,
            headers,
            {}, # query params
            json.dumps(payload),
            {}, # cookies
            TIMEOUT_MS
        )

        # Parse the response body
        response_content = response_dict.get("content", "")
        if not response_content:
             return "Error: Empty response from agent API."
             
        parsed_response = json.loads(response_content)

        # Extract the final text response.
        # Handle standard blocking response format
        if isinstance(parsed_response, dict) and 'message' in parsed_response:
            content_items = parsed_response['message'].get('content', [])
            for item in reversed(content_items):
                if isinstance(item, dict) and item.get("type") == "text":
                    return item.get("text", "No text found in response.")
        
        # Handle potential streaming-style chunks in blocking response
        if isinstance(parsed_response, list) and len(parsed_response) > 0:
             item = parsed_response[-1] # Get last chunk
             if 'message' in item and 'content' in item['message']:
                 content_block = item['message']['content'][-1]
                 if content_block.get('type') == 'text':
                     return content_block.get('text')

        return f"Could not parse response. Raw: {str(parsed_response)[:200]}..."

    except Exception as e:
        return f"An error occurred calling the agent API: {str(e)}"

# ==========================================
# MAIN HANDLER FUNCTION
# ==========================================
def main(session: snowpark.Session):
    # Generate a unique user ID for this test run
    test_user_id = f"worksheet_user_{int(time.time())}"
    test_query = "When does the fiscal year start? Please list the months of Q1."

    print(f"Starting Test Run for User: {test_user_id}")

    # --- PART 1: BEFORE FEEDBACK ---
    print("\n PART 1: BASELINE (Before Feedback) ")
    # The agent should give a generic answer.
    response_before = call_cortex_agent_internal(session, test_user_id, test_query)
    print(f"\n[AGENT REPLY BEFORE]:\n{response_before}\n")


    # --- PART 2: SUBMIT FEEDBACK & WAIT ---
    print("\n PART 2: TEACHING THE SYSTEM ")
    fb_text = "Global Rule: Our fiscal year begins on February 1st. User Preference: Use bullet points for lists."
    print(f"Submitting Feedback: '{fb_text}'")
    # Submit negative feedback to initiate the correction loop
    submit_feedback_sql(session, test_user_id, fb_text, is_positive=False)

    print("\n--- Waiting 130 seconds for background tasks to process... ---")
    # Wait for Classifier Task (1 min) + Summarizer Task (1 min) to finish cycles.
    # This allows data to flow from Staging -> Logs -> Memory.
    time.sleep(130) 
    print("--- Wait complete. Memory should be updated. ---")


    # --- PART 3: AFTER FEEDBACK ---
    print("\n PART 3: VERIFICATION (After Feedback) ")
    # Run the exact same query. The agent should now use the new memory.
    response_after = call_cortex_agent_internal(session, test_user_id, test_query)
    print(f"\n[AGENT REPLY AFTER]:\n{response_after}\n")

    return "Test Complete. Check output panel for results."
    }
}
$$);
Could not parse response. Raw: {'status': 500, 'content': '{\n\t"code":\t"300014",\n\t"message":\t"Cannot construct instance of `com.snowflake.snowapi.cortexliteagent.model.AgentRunRequest` (although at least one Creator exists): n...
[AGENT REPLY BEFORE]:
{'status': 500, 'content': '{\n\t"code":\t"300014",\n\t"message":\t"Cannot construct instance of `com.snowflake.snowapi.cortexdataagent.model.DataAgentRunRequest` (although at least one Creator exists): no String-argument constructor/factory method to deserialize from String value (\'{\"model\": \"claude-3-5-sonnet\", \"instructions\": {\"orchestration\": \"\\n    You are a helpful corporate analyst agent.\\n    - Never fabricate data.\\n    - If you use a tool to get data, rely ONLY on that data.\\n    - CRITICAL: You must adhere to the USER CONTEXT provided below in your logic.\\n    \\n\\n### USER CONTEXT ###\\nNo prior context.\", \"response\": \"\\n    - Be professional and concise.\\n    - Use Markdown for formatting.\\n    \"}, \"messages\": [{\"role\": \"user\", \"content\": [{\"type\": \"text\", \"text\": \"When does the fiscal year start? Please list the months of Q1.\"}]}], \"stream\": false}\')\n at [Source: (org.eclipse.jetty.server.HttpInputOverHTTP); line: 1, column: 1]",\n\t"request_id":\t"e1c38c66-6845-47f6-8f80-51c409533c1d",\n\t"error_code":\t"300014"\n}', 'headers': {'\nContent-Length': '1033', '\nDate': 'Thu, 08 Jan 2026 18:40:37 GMT', '\nX-Snowflake-Request-ID': 'e1c38c66-6845-47f6-8f80-51c409533c1d', '\nContent-Type': 'application/json'}}
 PART 2: TEACHING THE SYSTEM 
Submitting Feedback: 'Global Rule: Our fiscal year begins on February 1st. User Preference: Use bullet points for lists.'
 Feedback submitted for: worksheet_user_1767897637
--- Waiting 130 seconds for background tasks to process... ---
--- Wait complete. Memory should be updated. ---
 PART 3: VERIFICATION (After Feedback) 
--- Calling Agent for worksheet_user_1767897637 ---
 Memory Found: False (Length: 17)
[AGENT REPLY AFTER]:
{'status': 500, 'content': '{\n\t"code":\t"300014",\n\t"message":\t"Cannot construct instance of `com.snowflake.snowapi.cortexdataagent.model.DataAgentRunRequest` (although at least one Creator exists): no String-argument constructor/factory method to deserialize from String value (\'{\"model\": \"claude-3-5-sonnet\", \"instructions\": {\"orchestration\": \"\\n    You are a helpful corporate analyst agent.\\n    - Never fabricate data.\\n    - If you use a tool to get data, rely ONLY on that data.\\n    - CRITICAL: You must adhere to the USER CONTEXT provided below in your logic.\\n    \\n\\n### USER CONTEXT ###\\nNo prior context.\", \"response\": \"\\n    - Be professional and concise.\\n    - Use Markdown for formatting.\\n    \"}, \"messages\": [{\"role\": \"user\", \"content\": [{\"type\": \"text\", \"text\": \"When does the fiscal year start? Please list the months of Q1.\"}]}], \"stream\": false}\')\n at [Source: (org.eclipse.jetty.server.HttpInputOverHTTP); line: 1, column: 1]",\n\t"request_id":\t"2f23c5b9-1174-402f-ba88-64f165fd5e2a",\n\t"error_code":\t"300014"\n}', 'headers': {'\nContent-Type': 'application/json', '\nContent-Length': '1033', '\nDate': 'Thu, 08 Jan 2026 18:42:48 GMT', '\nX-Snowflake-Request-ID': '2f23c5b9-1174-402f-ba88-64f165fd5e2a'}}


Skip to main content
Skip to editor
Skip to results
Site





Worksheets
Selection deleted
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
    
    # --- CONFIGURATION ---
    # Endpoint for stateless agent execution - FIX THE QUOTES
    AGENT_ENDPOINT_URL = "/api/v2/databases/DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB/schemas/AI_POC/agents/FEEDBACK_NEW:run"
    TIMEOUT_MS = 180_000  # 3 minutes

    # 1. Retrieve Memory (Fast Lookup)
    try:
        mem_df = session.sql(f"SELECT current_summary FROM user_memory WHERE user_id = '{user_id}'").collect()
        retrieved_memory = mem_df[0]['CURRENT_SUMMARY'] if mem_df and mem_df[0]['CURRENT_SUMMARY'] else "No prior context."
        print(f" Memory Found: {len(retrieved_memory) > 20} (Length: {len(retrieved_memory)})")
    except:
        retrieved_memory = "No prior context."

    # 2. Define Instructions
    # Logic rules for the "brain"
    orchestration_rules = """
    You are a helpful corporate analyst agent.
    - Never fabricate data.
    - If you use a tool to get data, rely ONLY on that data.
    - CRITICAL: You must adhere to the USER CONTEXT provided below in your logic.
    """
    # Style rules for the "voice"
    response_rules = """
    - Be professional and concise.
    - Use Markdown for formatting.
    """

    # 3. Construct the Payload (using AgentInstruction schema)
    # We inject the retrieved memory directly into the orchestration block.
    payload = {
        "model": "claude-3-5-sonnet",  # Or your preferred supported model
        "instructions": {
            "orchestration": f"{orchestration_rules}\n\n### USER CONTEXT ###\n{retrieved_memory}",
            "response": response_rules
        },
        "messages": [
            {"role": "user", "content": [{"type": "text", "text": user_query}]}
        ],
        "stream": False
    }

    # Headers for internal API call
    headers = {
        "Content-Type": "application/json",
        "Accept": "application/json"
    }

    # 4. Make the internal API request
    try:
        response_dict = _snowflake.send_snow_api_request(
            "POST",
            AGENT_ENDPOINT_URL,
            headers,
            {},  # query params
            payload,
            {},  # cookies
            TIMEOUT_MS
        )
        print("Hi")
        # Parse the response body
        response_content = response_dict.get("content")
        # if not response_content:
        #     return "Error: Empty response from agent API."
        print(response_dict)    
        parsed_response = json.loads(response_content)

        # Extract the final text response.
        # Handle standard blocking response format
        if isinstance(parsed_response, dict) and 'message' in parsed_response:
            content_items = parsed_response['message'].get('content', [])
            for item in reversed(content_items):
                if isinstance(item, dict) and item.get("type") == "text":
                    return item.get("text", "No text found in response.")
        
        # Handle potential streaming-style chunks in blocking response
        if isinstance(parsed_response, list) and len(parsed_response) > 0:
            item = parsed_response[-1]  # Get last chunk
            if 'message' in item and 'content' in item['message']:
                content_block = item['message']['content'][-1]
                if content_block.get('type') == 'text':
                    return content_block.get('text')

        return f"Could not parse response. Raw: {str(parsed_response)[:200]}..."

    except Exception as e:
        return f"An error occurred calling the agent API: {str(e)}"
Starting Test Run for User: worksheet_user_1767899167
 PART 1: BASELINE (Before Feedback) 
--- Calling Agent for worksheet_user_1767899167 ---
 Memory Found: False (Length: 17)
Hi
{'status': 200, 'content': '[{\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"The"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" fiscal year start"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" date varies"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" depending"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" on the organization"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" and country:"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"\n\n**Most"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" common"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" fiscal"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" year starts"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t":**\n- **October"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" 1** (U"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t".S. federal"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" government)\n- **April"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" 1** (many"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" countries including"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" Japan"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t", India"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t", UK"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t")"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"\n- **January 1** ("\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"calendar"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" year -"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" many"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" businesses"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t")"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"\n- **July 1** (some"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" states"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" an"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"d organizations"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t")\n\n**Q"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"1 months"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" for"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" each"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t":**"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"\n\n-"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" **October"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" start"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t":** Q"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"1 ="\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" October,"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" November"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t", December\n- **April start:**"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" Q1 = April, May,"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" June  "\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"\n- **January start:** Q1"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" = January, February, March"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"\n- **July start:** Q1 "\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"= July, August, September\n\nIf"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" you\'re asking about a specific organization"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" or country, I"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"\'d be happy to provide"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t" more targete"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text.delta",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"d information!"\n\t\t}\n\t}, {\n\t\t"event":\t"response.text",\n\t\t"data":\t{\n\t\t\t"content_index":\t0,\n\t\t\t"text":\t"The fiscal year start date varies depending on the organization and country:\n\n**Most common fiscal year starts:**\n- **October 1** (U.S. federal government)\n- **April 1** (many countries including Japan, India, UK)\n- **January 1** (calendar year - many businesses)\n- **July 1** (some states and organizations)\n\n**Q1 months for each:**\n\n- **October start:** Q1 = October, November, December\n- **April start:** Q1 = April, May, June  \n- **January start:** Q1 = January, February, March\n- **July start:** Q1 = July, August, September\n\nIf you\'re asking about a specific organization or country, I\'d be happy to provide more targeted information!"\n\t\t}\n\t}, {\n\t\t"event":\t"response",\n\t\t"data":\t{\n\t\t\t"content":\t[{\n\t\t\t\t\t"text":\t"The fiscal year start date varies depending on the organization and country:\n\n**Most common fiscal year starts:**\n- **October 1** (U.S. federal government)\n- **April 1** (many countries including Japan, India, UK)\n- **January 1** (calendar year - many businesses)\n- **July 1** (some states and organizations)\n\n**Q1 months for each:**\n\n- **October start:** Q1 = October, November, December\n- **April start:** Q1 = April, May, June  \n- **January start:** Q1 = January, February, March\n- **July start:** Q1 = July, August, September\n\nIf you\'re asking about a specific organization or country, I\'d be happy to provide more targeted information!",\n\t\t\t\t\t"type":\t"text"\n\t\t\t\t}],\n\t\t\t"metadata":\t{\n\t\t\t\t"usage":\t{\n\t\t\t\t\t"tokens_consumed":\t[{\n\t\t\t\t\t\t\t"context_window":\t200000,\n\t\t\t\t\t\t\t"input_tokens":\t{\n\t\t\t\t\t\t\t\t"cache_read":\t0,\n\t\t\t\t\t\t\t\t"cache_write":\t0,\n\t\t\t\t\t\t\t\t"total":\t78,\n\t\t\t\t\t\t\t\t"uncached":\t78\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t"model_name":\t"claude-4-sonnet",\n\t\t\t\t\t\t\t"output_tokens":\t{\n\t\t\t\t\t\t\t\t"total":\t175\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}]\n\t\t\t\t}\n\t\t\t},\n\t\t\t"role":\t"assistant",\n\t\t\t"schema_version":\t"v2"\n\t\t}\n\t}, {\n\t\t"event":\t"done",\n\t\t"data":\t"[DONE]"\n\t}]', 'headers': {'\nDate': 'Thu, 08 Jan 2026 19:06:08 GMT', '\nX-Snowflake-Request-ID': '32911316-3d54-4627-a217-a074a4a3fd52', '\nContent-Type': 'application/json', '\nTransfer-Encoding': 'chunked'}}
[AGENT REPLY BEFORE]:
Could not parse response. Raw: [{'event': 'response.text.delta', 'data': {'content_index': 0, 'text': 'The'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' fiscal year start'}}, {'event': 'response.text.d...

Starting Test Run for User: worksheet_user_1767900217


import _snowflake
import json
import time
import snowflake.snowpark as snowpark
from snowflake.snowpark.exceptions import SnowparkSQLException

# ==========================================
# HELPER 1: FAST FEEDBACK SUBMISSION (SQL)
# ==========================================
def submit_feedback_sql(session: snowpark.Session, user_id: str, text: str, is_positive: bool):
    try:
        # Simple SQL-safe string escape
        clean_text = text.replace("'", "''")
        query = f"""
            INSERT INTO feedback_staging 
            (user_id, feedback_text, feedback_rating)
            VALUES ('{user_id}', '{clean_text}', {is_positive})
        """
        session.sql(query).collect()
        print(f" Feedback submitted for: {user_id}")
    except Exception as e:
        print(f" Submit Error: {e}")

# ==========================================
# HELPER 2: CALL AGENT VIA INTERNAL API
# ==========================================
def call_cortex_agent_internal(session: snowpark.Session, user_id: str, user_query: str):
    print(f"\n--- Calling Agent for {user_id} ---")
    
    # --- CONFIGURATION ---
    # Endpoint for stateless agent execution - FIX THE QUOTES
    AGENT_ENDPOINT_URL = "/api/v2/databases/DEV_P_PAIN_SALES_PERFORMANCE_ANALYTICS_DB/schemas/AI_POC/agents/FEEDBACK_NEW:run"
    TIMEOUT_MS = 180_000  # 3 minutes

    # 1. Retrieve Memory (Fast Lookup)
    try:
        mem_df = session.sql(f"SELECT current_summary FROM user_memory WHERE user_id = '{user_id}'").collect()
        retrieved_memory = mem_df[0]['CURRENT_SUMMARY'] if mem_df and mem_df[0]['CURRENT_SUMMARY'] else "No prior context."
        print(f" Memory Found: {len(retrieved_memory) > 20} (Length: {len(retrieved_memory)})")
    except:
        retrieved_memory = "No prior context."

    # 2. Define Instructions
    # Logic rules for the "brain"
    orchestration_rules = """
    You are a helpful corporate analyst agent.
    - Never fabricate data.
    - If you use a tool to get data, rely ONLY on that data.
    - CRITICAL: You must adhere to the USER CONTEXT provided below in your logic.
    """
    # Style rules for the "voice"
    response_rules = """
    - Be professional and concise.
    - Use Markdown for formatting.
    """

    # 3. Construct the Payload (using AgentInstruction schema)
    # We inject the retrieved memory directly into the orchestration block.
    payload = {
        "model": "claude-3-5-sonnet",  # Or your preferred supported model
        "instructions": {
            "orchestration": f"{orchestration_rules}\n\n### USER CONTEXT ###\n{retrieved_memory}",
            "response": response_rules
        },
        "messages": [
            {"role": "user", "content": [{"type": "text", "text": user_query}]}
        ],
        "stream": False
    }

    # Headers for internal API call
    headers = {
        "Content-Type": "application/json",
        "Accept": "application/json"
    }

    # 4. Make the internal API request
    try:
        response_dict = _snowflake.send_snow_api_request(
            "POST",
            AGENT_ENDPOINT_URL,
            headers,
            {},  # query params
            payload,
            {},  # cookies
            TIMEOUT_MS
        )

        # Parse the response body
        response_content = response_dict.get("content", "")
        if not response_content:
            return "Error: Empty response from agent API."
             
        parsed_response = json.loads(response_content)

        # Extract the final text response.
        # Handle standard blocking response format
        if isinstance(parsed_response, dict) and 'message' in parsed_response:
            content_items = parsed_response['message'].get('content', [])
            for item in reversed(content_items):
                if isinstance(item, dict) and item.get("type") == "text":
                    return item.get("text", "No text found in response.")
        
        # Handle potential streaming-style chunks in blocking response
        if isinstance(parsed_response, list) and len(parsed_response) > 0:
            item=parsed_response
            print(parsed_response)
            if 'event' in item and 'response' in item['event']:
                content_block = item['data']['content'][-1]
                if content_block.get('type') == 'text':
                    return content_block.get('text')

        return f"Could not parse response. Raw: {str(parsed_response)[:200]}..."

    except Exception as e:
        return f"An error occurred calling the agent API: {str(e)}"

# ==========================================
# MAIN HANDLER FUNCTION
# ==========================================
def main(session: snowpark.Session):
    # Generate a unique user ID for this test run
    test_user_id = f"worksheet_user_{int(time.time())}"
    test_query = "When does the fiscal year start? Please list the months of Q1."

    print(f"Starting Test Run for User: {test_user_id}")

    # --- PART 1: BEFORE FEEDBACK ---
    print("\n PART 1: BASELINE (Before Feedback) ")
    # The agent should give a generic answer.
    response_before = call_cortex_agent_internal(session, test_user_id, test_query)
    print(f"\n[AGENT REPLY BEFORE]:\n{response_before}\n")

    # # --- PART 2: SUBMIT FEEDBACK & WAIT ---
    # print("\n PART 2: TEACHING THE SYSTEM ")
    # fb_text = "Global Rule: Our fiscal year begins on February 1st. User Preference: Use bullet points for lists."
    # print(f"Submitting Feedback: '{fb_text}'")
    # # Submit negative feedback to initiate the correction loop
    # submit_feedback_sql(session, test_user_id, fb_text, is_positive=False)

    # print("\n--- Waiting 130 seconds for background tasks to process... ---")
    # # Wait for Classifier Task (1 min) + Summarizer Task (1 min) to finish cycles.
    # # This allows data to flow from Staging -> Logs -> Memory.
    # time.sleep(130) 
    # print("--- Wait complete. Memory should be updated. ---")

    # # --- PART 3: AFTER FEEDBACK ---
    # print("\n PART 3: VERIFICATION (After Feedback) ")
    # # Run the exact same query. The agent should now use the new memory.
    # response_after = call_cortex_agent_internal(session, test_user_id, test_query)
    # print(f"\n[AGENT REPLY AFTER]:\n{response_after}\n")

    # return "Test Complete. Check output panel for results."

 PART 1: BASELINE (Before Feedback) 
--- Calling Agent for worksheet_user_1767900217 ---
 Memory Found: False (Length: 17)
[{'event': 'response.text.delta', 'data': {'content_index': 0, 'text': 'The'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' fiscal year start'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' date varies'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' depending'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' on the organization'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' or'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' country:'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': '\n\n**Common'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' fiscal year start dates:**\n- **'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': 'October'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' 1** (U'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': '.S. federal government)\n-'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' **April'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' 1** (many'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' countries including'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' Japan'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ', India'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ', UK'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ')'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': '\n- **January 1** ('}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': 'calendar'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' year, use'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': 'd by many'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' businesses'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ')\n- **July 1**'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' (some'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' states'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' an'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': 'd organizations'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ')\n\n**Q'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': '1 months'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' depen'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': 'd on the'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' fiscal'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' year start'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ':**'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': '\n\n-'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' If'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' fiscal'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' year starts **'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': 'October 1**:'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' Q1 ='}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' October,'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' November'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ', December\n- If fiscal year starts'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' **April 1**: Q1 '}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': '= April, May, June  '}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': '\n- If fiscal year starts **January'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' 1**: Q1 = January'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ', February, March\n- If fiscal'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' year starts **July 1**: Q'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': '1 = July, August, September'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': '\n\nThe'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' most'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' common fiscal'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' year for'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' the'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' U.S. federal'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' government starts'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' October'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' 1,'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' so'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' Q1 woul'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': 'd be October, November, an'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': 'd December.'}}, {'event': 'response.text', 'data': {'content_index': 0, 'text': 'The fiscal year start date varies depending on the organization or country:\n\n**Common fiscal year start dates:**\n- **October 1** (U.S. federal government)\n- **April 1** (many countries including Japan, India, UK)\n- **January 1** (calendar year, used by many businesses)\n- **July 1** (some states and organizations)\n\n**Q1 months depend on the fiscal year start:**\n\n- If fiscal year starts **October 1**: Q1 = October, November, December\n- If fiscal year starts **April 1**: Q1 = April, May, June  \n- If fiscal year starts **January 1**: Q1 = January, February, March\n- If fiscal year starts **July 1**: Q1 = July, August, September\n\nThe most common fiscal year for the U.S. federal government starts October 1, so Q1 would be October, November, and December.'}}, {'event': 'response', 'data': {'content': [{'text': 'The fiscal year start date varies depending on the organization or country:\n\n**Common fiscal year start dates:**\n- **October 1** (U.S. federal government)\n- **April 1** (many countries including Japan, India, UK)\n- **January 1** (calendar year, used by many businesses)\n- **July 1** (some states and organizations)\n\n**Q1 months depend on the fiscal year start:**\n\n- If fiscal year starts **October 1**: Q1 = October, November, December\n- If fiscal year starts **April 1**: Q1 = April, May, June  \n- If fiscal year starts **January 1**: Q1 = January, February, March\n- If fiscal year starts **July 1**: Q1 = July, August, September\n\nThe most common fiscal year for the U.S. federal government starts October 1, so Q1 would be October, November, and December.', 'type': 'text'}], 'metadata': {'usage': {'tokens_consumed': [{'context_window': 200000, 'input_tokens': {'cache_read': 0, 'cache_write': 0, 'total': 78, 'uncached': 78}, 'model_name': 'claude-4-sonnet', 'output_tokens': {'total': 211}}]}}, 'role': 'assistant', 'schema_version': 'v2'}}, {'event': 'done', 'data': '[DONE]'}]
[AGENT REPLY BEFORE]:
Could not parse response. Raw: [{'event': 'response.text.delta', 'data': {'content_index': 0, 'text': 'The'}}, {'event': 'response.text.delta', 'data': {'content_index': 0, 'text': ' fiscal year start'}}, {'event': 'response.text.d...
